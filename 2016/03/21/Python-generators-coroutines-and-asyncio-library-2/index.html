<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Python coroutines and asyncio library (2) | Coupon Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Reading notes for the book *Fluent Python* and the `500lines/crawler` project">
<meta property="og:type" content="article">
<meta property="og:title" content="Python coroutines and asyncio library (2)">
<meta property="og:url" content="http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/index.html">
<meta property="og:site_name" content="Coupon Collector">
<meta property="og:description" content="Reading notes for the book *Fluent Python* and the `500lines/crawler` project">
<meta property="og:updated_time" content="2016-06-20T07:37:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python coroutines and asyncio library (2)">
<meta name="twitter:description" content="Reading notes for the book *Fluent Python* and the `500lines/crawler` project">
  
    <link rel="alternate" href="/atom.xml" title="Coupon Collector" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Coupon Collector</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">miscellaneous notes</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/links">Links</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://xyguo.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Python-generators-coroutines-and-asyncio-library-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/" class="article-date">
  <time datetime="2016-03-21T03:29:22.000Z" itemprop="datePublished">2016-03-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Python coroutines and asyncio library (2)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h1><p>Suitable for <strong>I/O-bound</strong> tasks.</p>
<h3 id="futures"><a href="#futures" class="headerlink" title="futures"></a><code>futures</code></h3><p>“futures” — objects representing the asynchronous execution of an operation<br>an instance of either <code>asyncio.Future</code> or <code>concurrent.futures.Future</code> class represents a <strong>deferred</strong> computation that may or may not have completed. This is similar to the <code>Deferred</code> class in Twisted, the <code>Future</code> class in Tornado, and <code>Promise</code> objects in various JavaScript libraries.</p>
<ul>
<li><code>concurrent.futures</code> is based on thread/process rather than coroutines.</li>
<li>Client code is not supposed to change the state of a future: the concurrency framework changes the state of a future when the computation it represents is done, and we can’t control when that happens.</li>
<li>Users should not create them: they are meant to be instantiated exclusively by the concurrency framework, be it <code>concurrent.futures</code> or <code>asyncio</code>.</li>
<li><code>concurrent.futures.ThreadPoolExecutor</code> ::</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"><span class="keyword">from</span> flags <span class="keyword">import</span> save_flag, get_flag, show, main </div><div class="line"></div><div class="line">MAX_WORKERS = <span class="number">20</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc)</span>:</span></div><div class="line">    image = get_flag(cc)</div><div class="line">    show(cc)</div><div class="line">    save_flag(image, cc.lower() + <span class="string">'.gif'</span>) </div><div class="line">    <span class="keyword">return</span> cc</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span></div><div class="line">    workers = min(MAX_WORKERS, len(cc_list))</div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(workers) <span class="keyword">as</span> executor:</div><div class="line">        <span class="comment"># the `.map` method works like the built-in `map` method; it returns a generator that can be iterated over to </span></div><div class="line">        <span class="comment"># retrieve the value returned by each function (`download_one` here).</span></div><div class="line">        <span class="comment"># When iterating on the generator returned by `.map`, the `__next__` call invokes the `.result` method of each</span></div><div class="line">        <span class="comment"># future, and yield the result if the future is done. So here we cannot touch futures directly.</span></div><div class="line">        res = executor.map(download_one, sorted(cc_list)) </div><div class="line"></div><div class="line">    <span class="comment"># if any of the threaded calls raised an exception, that exception would be raised here as the implicit `next()`</span></div><div class="line">    <span class="comment"># call tried to retrieve the corresponding return value from the iterator.</span></div><div class="line">    <span class="keyword">return</span> len(list(res))</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main(download_many)</div></pre></td></tr></table></figure>
<p><code>concurrent.futures.as_completed</code><br>An idiom that’s very useful with <code>futures.as_completed</code>: building a dict to map each future to other data that may be useful when the future is <strong>completed</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> collections</div><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus </div><div class="line"><span class="keyword">from</span> flags2_sequential <span class="keyword">import</span> download_one</div><div class="line"></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">30</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(max_workers=concur_req) <span class="keyword">as</span> executor:</div><div class="line">        to_do_map = &#123;&#125;</div><div class="line">        <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list):</div><div class="line">            future = executor.submit(download_one,</div><div class="line">                            cc, base_url, verbose)</div><div class="line">            <span class="comment"># This dict will map each `Future` instance — representing one download — with the respective </span></div><div class="line">            <span class="comment"># country code for error reporting.</span></div><div class="line">            to_do_map[future] = cc</div><div class="line">        <span class="comment"># futures.as_completed returns an iterator that yields futures as they are done.</span></div><div class="line">        done_iter = futures.as_completed(to_do_map) </div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">            done_iter = tqdm.tqdm(done_iter, total=len(cc_list)) </div><div class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> done_iter:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                res = future.result()</div><div class="line">            <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> exc:</div><div class="line">                error_msg = <span class="string">'HTTP &#123;res.status_code&#125; - &#123;res.reason&#125;'</span> </div><div class="line">                error_msg = error_msg.format(res=exc.response)</div><div class="line">            <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> exc: </div><div class="line">                error_msg = <span class="string">'Connection error'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                error_msg = <span class="string">''</span></div><div class="line">                status = res.status</div><div class="line"></div><div class="line">            <span class="keyword">if</span> error_msg:</div><div class="line">                status = HTTPStatus.error</div><div class="line">            counter[status] += <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                <span class="comment"># This was not necessary in the sequential version because we were iterating over the list </span></div><div class="line">                <span class="comment"># of country codes, so we had the current `cc`; here we are iterating over the futures.</span></div><div class="line">                cc = to_do_map[future]</div><div class="line">                print(<span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span>.format(cc, error_msg))</div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>
<h3 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a><code>asyncio</code></h3><p>Integrated into the standard library in Python <strong>3.4</strong>. Provides a way to drive asynchronous programs using <strong>event loop</strong>, which is different from Node.js.</p>
<p>Compared to multi-thread solutions, coroutines resides in a single thread, thus avoids most overhead due to thread context-switch. Plus, any time there can be only one coroutine running and it give out control actively, thus avoids most headaches due to synchronization since the coroutine knows that it won’t be interrupted unless voluntary suspends with <code>yield</code> (or <code>yield from</code>).</p>
<p>Note that, by design, there is no API for terminating a <strong>thread</strong> in Python. You must send it a message to shut down. Due to the GIL, race condition is alleviated at the expense of losing parallism. While for a coroutines, it can only be cancelled when it’s suspended at a <code>yield</code> point, so you can perform cleanup by handling the <code>CancelledError</code> exception (see below).</p>
<h4 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h4><p>“coroutine” in the context of <code>asyncio</code><br>A coroutine suitable for use with the <code>asyncio</code> API must use <code>yield from</code> and <strong>not</strong> <code>yield</code> in its body. Also, an <code>asyncio</code> coroutine should be driven by a caller invoking it through <code>yield from</code> or by passing the coroutine to one of the <code>asyncio</code> functions such as <code>asyncio.async(...)</code>. Finally, the <code>@asyncio.coroutine</code> decorator should be applied to coroutines.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="comment"># Coroutines intended for use with asyncio should be decorated with `@asyncio.coroutine`. </span></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spin</span><span class="params">(msg)</span>:</span></div><div class="line">write, flush = sys.stdout.write, sys.stdout.flush </div><div class="line"><span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">'|/-\\'</span>):</div><div class="line">    status = char + <span class="string">' '</span> + msg write(status)</div><div class="line">    flush()</div><div class="line">    write(<span class="string">'\x08'</span> * len(status)) </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># Use `yield from asyncio.sleep(.1)` instead of just `time.sleep(.1)`</span></div><div class="line">        <span class="comment"># to sleep without blocking the event loop.</span></div><div class="line">        <span class="comment"># Never use `time.sleep(...)` in `asyncio` coroutines unless you want to block the main thread,</span></div><div class="line">        <span class="comment"># therefore freezing the event loop and probably the whole application as well.</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">.1</span>) </div><div class="line">    <span class="comment"># The `CancelledError` exception can be catched in the `yield` where the coroutine is suspended.</span></div><div class="line">    <span class="keyword">except</span> asyncio.CancelledError:</div><div class="line">        <span class="keyword">break</span></div><div class="line">write(<span class="string">' '</span> * len(status) + <span class="string">'\x08'</span> * len(status))</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_function</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># pretend waiting a long time for I/O </span></div><div class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">3</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">42</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">supervisor</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># `asyncio.async(...)` schedules the `spin` coroutine to run, wrapping it in a `Task` </span></div><div class="line">    <span class="comment"># object, which is returned immediately. When you get a `Task` object, it is already scheduled to run</span></div><div class="line">    spinner = asyncio.<span class="keyword">async</span>(spin(<span class="string">'thinking!'</span>)) </div><div class="line">    print(<span class="string">'spinner object:'</span>, spinner)</div><div class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> slow_function() </div><div class="line">    <span class="comment"># This raises `CancelledError` inside the coroutine.</span></div><div class="line">    spinner.cancel()</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    <span class="comment"># Drive the supervisor coroutine to completion; </span></div><div class="line">    <span class="comment"># the return value of the coroutine is the return value of this call.</span></div><div class="line">    result = loop.run_until_complete(supervisor()) </div><div class="line">    loop.close()</div><div class="line">    print(<span class="string">'Answer:'</span>, result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main()</div></pre></td></tr></table></figure>
<p><code>asyncio.Futures</code> is designed to work with <code>yield from</code>  </p>
<ul>
<li>Using <code>yield from</code> with a future is the <strong>coroutine equivalent</strong> of the functionality offered by <code>add_donecallback</code>: instead of triggering a callback, when the delayed operation is done, the event loop sets the result of the future, and the <code>yield from</code> expression produces a return value inside our suspended coroutine, allowing it to resume.</li>
<li>You don’t need <code>my_future.add_donecallback(...)</code> because you can simply put whatever processing you would do after the future is done in the lines that follow <code>yield from my_future</code> in your coroutine. That’s the big advantage of having coroutines: functions that can be suspended and resumed.</li>
<li>You don’t need <code>my_future.result()</code> because the value of a <code>yield from</code> expression on a future is the result (e.g., <code>result = yield from my_future</code>).</li>
</ul>
<p>yielding from <code>Future</code>s, <code>Task</code>s, and coroutines<br>In <code>asyncio</code>, there is a close relationship between futures and coroutines because you can get the result of an <code>asyncio.Future</code> by yielding from it. This means that <code>res = yield from foo()</code> works if <code>foo</code> is a coroutine function (therefore it returns a coroutine object when called) or <strong>if <code>foo</code> is a plain function that returns a <code>Future</code> or <code>Task</code> instance</strong>.</p>
<p>executing coroutines<br>In order to execute, a coroutine must be scheduled, and then it’s wrapped in an <code>asyncio.Task</code>. Given a coroutine, there are two main ways of obtaining a Task:</p>
<p><code>asyncio.async(coro_orfuture, \*, loop=None)</code><br>This function unifies coroutines and futures: the first argument can be either one. If it’s a <code>Future</code> or <code>Task</code>, it’s returned unchanged. <strong>If it’s a coroutine, <code>async</code> calls <code>loop.create_task(...)</code> on it to create a <code>Task</code></strong>. An optional event loop may be passed as the <code>loop=</code> keyword argument; if omitted, <code>async</code> gets the loop object by calling <code>asyncio.get_eventloop()</code>.</p>
<p><code>BaseEventLoop.create_task(coro)</code><br>This method schedules the coroutine for execution and returns an <code>asyncio.Task</code> object. If called on a custom subclass of <code>BaseEventLoop</code>, the object returned may be an instance of some other Task-compatible class provided by an external library (e.g., Tornado).</p>
<ul>
<li>A coroutine only does anything when <strong>driven</strong>, and to drive an <code>asyncio.coroutine</code> you either use <code>yield from</code> or pass it to one of several <code>asyncio</code> functions that take coroutine or future arguments, such as <strong><code>run_untilcomplete</code></strong>. Several <code>asyncio</code> functions accept coroutines and wrap them in <code>asyncio.Task</code> objects automatically, <strong>using <code>asyncio.async</code> internally</strong>. One example is <strong><code>BaseEventLoop.run_untilcomplete(...)</code></strong>.</li>
</ul>
<h4 id="Downloading-with-asyncio-and-aiohttp"><a href="#Downloading-with-asyncio-and-aiohttp" class="headerlink" title="Downloading with asyncio and aiohttp"></a>Downloading with <code>asyncio</code> and <code>aiohttp</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> collections</div><div class="line"></div><div class="line"><span class="keyword">import</span> aiohttp</div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"></div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus, Result, save_flag</div><div class="line"></div><div class="line"><span class="comment"># default set low to avoid errors from remote site, such as</span></div><div class="line"><span class="comment"># 503 - Service Temporarily Unavailable</span></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">5</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FetchError</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, country_code)</span>:</span></div><div class="line">        self.country_code = country_code</div><div class="line"></div><div class="line"><span class="comment"># BEGIN FLAGS3_ASYNCIO</span></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_get</span><span class="params">(url)</span>:</span></div><div class="line">    res = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">'GET'</span>, url)</div><div class="line">    <span class="keyword">if</span> res.status == <span class="number">200</span>:</div><div class="line">        ctype = res.headers.get(<span class="string">'Content-type'</span>, <span class="string">''</span>).lower()</div><div class="line">        <span class="keyword">if</span> <span class="string">'json'</span> <span class="keyword">in</span> ctype <span class="keyword">or</span> url.endswith(<span class="string">'json'</span>):</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.json()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.read()</div><div class="line">        <span class="keyword">return</span> data</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> res.status == <span class="number">404</span>:</div><div class="line">        <span class="keyword">raise</span> web.HTTPNotFound()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">raise</span> aiohttp.errors.HttpProcessingError(</div><div class="line">            code=res.status, message=res.reason,</div><div class="line">            headers=res.headers)</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_country</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/metadata.json'</span>.format(base_url, cc=cc.lower())</div><div class="line">    metadata = <span class="keyword">yield</span> <span class="keyword">from</span> http_get(url)</div><div class="line">    <span class="keyword">return</span> metadata[<span class="string">'country'</span>]</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(base_url, cc=cc.lower())</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">yield</span> <span class="keyword">from</span> http_get(url))</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc, base_url, semaphore, verbose)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># A semaphore is used as a context manager in a `yield from` expression so that the system </span></div><div class="line">        <span class="comment"># as whole is not blocked: *only this coroutine* is blocked while the semaphore counter is at the </span></div><div class="line">        <span class="comment"># maximum allowed number.</span></div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(base_url, cc)</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            country = <span class="keyword">yield</span> <span class="keyword">from</span> get_country(base_url, cc)</div><div class="line">    <span class="keyword">except</span> web.HTTPNotFound:</div><div class="line">        status = HTTPStatus.not_found</div><div class="line">        msg = <span class="string">'not found'</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">        <span class="comment"># Any other exception will be reported as a `FetchError` with the country code and the original </span></div><div class="line">        <span class="comment"># exception chained using the `raise X from Y` syntax introduced in PEP 3134 — Exception </span></div><div class="line">        <span class="comment"># Chaining and Embedded Tracebacks.</span></div><div class="line">        <span class="keyword">raise</span> FetchError(cc) <span class="keyword">from</span> exc</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        country = country.replace(<span class="string">' '</span>, <span class="string">'_'</span>)</div><div class="line">        filename = <span class="string">'&#123;&#125;-&#123;&#125;.gif'</span>.format(country, cc)</div><div class="line">        loop = asyncio.get_event_loop()</div><div class="line">        <span class="comment"># Behind the scenes, the `asyncio` event loop has a thread pool executor, and you can send callables to be </span></div><div class="line">        <span class="comment"># executed by it with `run_in_executor`. This prevent the I/O function `save_fig` from blocking the whole thread.</span></div><div class="line">        loop.run_in_executor(<span class="keyword">None</span>, save_flag, image, filename)</div><div class="line">        status = HTTPStatus.ok</div><div class="line">        msg = <span class="string">'OK'</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> msg:</div><div class="line">        print(cc, msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Result(status, cc)</div><div class="line"><span class="comment"># END FLAGS3_ASYNCIO</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader_coro</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    <span class="comment"># Calling `.acquire()` does not block when the counter is greater than zero, but if the counter is zero, </span></div><div class="line">    <span class="comment"># `.acquire()` will block the calling *coroutine* until some other coroutine calls `.release()` on the same </span></div><div class="line">    <span class="comment"># `Semaphore`, thus incrementing the counter.</span></div><div class="line">    semaphore = asyncio.Semaphore(concur_req)</div><div class="line">    to_do = [download_one(cc, base_url, semaphore, verbose)</div><div class="line">             <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list)]</div><div class="line"></div><div class="line">    <span class="comment"># Note that the futures returned by `asyncio.as_completed` are not necessarily the same </span></div><div class="line">    <span class="comment"># futures passed into the `as_completed` call.</span></div><div class="line">    to_do_iter = asyncio.as_completed(to_do)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">        to_do_iter = tqdm.tqdm(to_do_iter, total=len(cc_list))</div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> to_do_iter:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            res = <span class="keyword">yield</span> <span class="keyword">from</span> future</div><div class="line">        <span class="keyword">except</span> FetchError <span class="keyword">as</span> exc:</div><div class="line">            country_code = exc.country_code</div><div class="line">            <span class="comment"># Try to retrieve the error message from the original exception (`__cause__`).</span></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                error_msg = exc.__cause__.args[<span class="number">0</span>]</div><div class="line">            <span class="comment"># If the error message cannot be found in the original exception, use the name </span></div><div class="line">            <span class="comment"># of the chained exception class as the error message.</span></div><div class="line">            <span class="keyword">except</span> IndexError:</div><div class="line">                error_msg = exc.__cause__.__class__.__name__</div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                msg = <span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span></div><div class="line">                print(msg.format(country_code, error_msg))</div><div class="line">            status = HTTPStatus.error</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            status = res.status</div><div class="line"></div><div class="line">        counter[status] += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    coro = downloader_coro(cc_list, base_url, verbose, concur_req)</div><div class="line">    counts = loop.run_until_complete(coro)</div><div class="line">    loop.close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> counts</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>
<h4 id="asyncio-Servers"><a href="#asyncio-Servers" class="headerlink" title="asyncio Servers"></a><code>asyncio</code> Servers</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">from</span> charfinder <span class="keyword">import</span> UnicodeNameIndex </div><div class="line"></div><div class="line">CRLF = <span class="string">b'\r\n'</span></div><div class="line">PROMPT = <span class="string">b'?&gt; '</span></div><div class="line">index = UnicodeNameIndex()</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_queries</span><span class="params">(reader, writer)</span>:</span> </div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="comment"># can't `yield from` since the `StreamWriter.write` method is not a coroutine, just a plain function</span></div><div class="line">        writer.write(PROMPT)</div><div class="line">        <span class="comment"># `StreamWriter.drain` flushes the writer buffer; it is a coroutine, so it must be called with `yield from`.</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">        data = <span class="keyword">yield</span> <span class="keyword">from</span> reader.readline()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            query = data.decode().strip() </div><div class="line">        <span class="keyword">except</span> UnicodeDecodeError:</div><div class="line">            query = <span class="string">'\x00'</span></div><div class="line">        client = writer.get_extra_info(<span class="string">'peername'</span>) </div><div class="line">        print(<span class="string">'Received from &#123;&#125;: &#123;!r&#125;'</span>.format(client, query)) </div><div class="line">        <span class="keyword">if</span> query:</div><div class="line">            <span class="keyword">if</span> ord(query[:<span class="number">1</span>]) &lt; <span class="number">32</span>: </div><div class="line">                <span class="keyword">break</span></div><div class="line">            lines = list(index.find_description_strs(query)) </div><div class="line">            <span class="keyword">if</span> lines:</div><div class="line">                writer.writelines(line.encode() + CRLF <span class="keyword">for</span> line <span class="keyword">in</span> lines) </div><div class="line">            writer.write(index.status(query, len(lines)).encode() + CRLF)</div><div class="line"></div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">            print(<span class="string">'Sent &#123;&#125; results'</span>.format(len(lines)))</div><div class="line"></div><div class="line">    print(<span class="string">'Close the client socket'</span>) </div><div class="line">    writer.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(address=<span class="string">'127.0.0.1'</span>, port=<span class="number">2323</span>)</span>:</span> </div><div class="line">    port = int(port)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    <span class="comment"># When completed, the coroutine object returned by `asyncio.start_server`</span></div><div class="line">    <span class="comment"># returns an instance of `asyncio.Server`, a TCP socket server.</span></div><div class="line">    server_coro = asyncio.start_server(handle_queries, address, port,</div><div class="line">                                loop=loop)</div><div class="line">    <span class="comment"># Drive server_coro to bring up the server.</span></div><div class="line">    server = loop.run_until_complete(server_coro)</div><div class="line">    host = server.sockets[<span class="number">0</span>].getsockname()</div><div class="line">    print(<span class="string">'Serving on &#123;&#125;. Hit CTRL-C to stop.'</span>.format(host)) </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># Run the event loop; this is where `main` will block until killed when CTRL-C is </span></div><div class="line">        <span class="comment"># pressed on the server console.</span></div><div class="line">        loop.run_forever()</div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt: <span class="comment"># CTRL+C pressed</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    print(<span class="string">'Server shutting down.'</span>) </div><div class="line">    server.close() </div><div class="line">    <span class="comment"># `server.wait_closed()` returns a future; use `loop.run_until_complete` to let the future do its job.</span></div><div class="line">    loop.run_until_complete(server.wait_closed()) </div><div class="line">    loop.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main(*sys.argv[<span class="number">1</span>:])</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/" data-id="cj3e7fp0a000n9v4ktugaabn1" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/26/mit-distributed-system-course-summary/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Summary for MIT 6.824- Course projects
        
      </div>
    </a>
  
  
    <a href="/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Python coroutines and asyncio library (1)</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/english-writing/">english-writing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">programming</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Emacs/">Emacs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-system/">distributed-system</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/puzzle/">puzzle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writing/">writing</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/Linux-Kernel/" style="font-size: 20px;">Linux Kernel</a> <a href="/tags/distributed-system/" style="font-size: 10px;">distributed-system</a> <a href="/tags/math/" style="font-size: 15px;">math</a> <a href="/tags/programming/" style="font-size: 10px;">programming</a> <a href="/tags/puzzle/" style="font-size: 10px;">puzzle</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/writing/" style="font-size: 10px;">writing</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/19/english-writing-notes-on-style-book-1/">Reading notes on book &quot;Style - Lessons in Clarity and Grace&quot; -- Unit 3 - Actions</a>
          </li>
        
          <li>
            <a href="/2016/09/22/chernoff-hoeffding/">Chernoff-Hoeffding Bound</a>
          </li>
        
          <li>
            <a href="/2016/03/26/mit-distributed-system-course-summary/">Summary for MIT 6.824- Course projects</a>
          </li>
        
          <li>
            <a href="/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/">Python coroutines and asyncio library (2)</a>
          </li>
        
          <li>
            <a href="/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/">Python coroutines and asyncio library (1)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 xyguo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/links" class="mobile-nav-link">Links</a>
  
</nav>
    
<script>
  var disqus_shortname = 'xyguo';
  
  var disqus_url = 'http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>