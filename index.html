<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Coupon Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Coupon Collector">
<meta property="og:url" content="http://xyguo.github.io/index.html">
<meta property="og:site_name" content="Coupon Collector">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Coupon Collector">
  
    <link rel="alternate" href="/atom.xml" title="Coupon Collector" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Coupon Collector</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">miscellaneous notes</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/links">Links</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://xyguo.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-notes-on-style-book-ch4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/05/notes-on-style-book-ch4/" class="article-date">
  <time datetime="2017-06-05T02:29:22.000Z" itemprop="datePublished">2017-06-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/english-writing/">english-writing</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/05/notes-on-style-book-ch4/">English writing - Characters</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>This is the reading notes for book <em>Style - Lessons in Clarity and Grace</em></p>
</blockquote>
<hr>
<blockquote>
<p>The first principle of a clear style is this: Make the subjects of most of your verbs the main characters in your story.</p>
</blockquote>
<h2 id="Diagnosis-and-revision"><a href="#Diagnosis-and-revision" class="headerlink" title="Diagnosis and revision"></a>Diagnosis and revision</h2><ol>
<li>Underline the first seven or eight words to see the subjects. If the main characters are not expressed in a few short, concrete words, proceed to the next step.</li>
<li>Find the main characters. They may be possessive pronouns attached to nominalizations, objects of prepositions, or only implied.</li>
<li>Skim the passage for actions involving those characters, particularly actions buried in nominalizations. Ask <em>Who is doing what</em>?</li>
<li>Reassemble those revealed subjects and verbs into a sentence, using conjunctions if necessary.</li>
</ol>
<ul>
<li>Example: Governmental intervention in fast-changing technologies has led to the distortion of market evolution and interference in new product developing.<ol>
<li><u>Governmental intervention in fast-changing technologies has led</u> to the distortion of market evolution and interference in new product developing.</li>
<li>The main character is hidden in the adjective <em>Governmental</em>.</li>
<li><ul>
<li>governmental <strong>intervention</strong> –&gt; goverment intervenes </li>
<li><strong>distortion</strong> –&gt; [government] distorts </li>
<li>market <strong>evolution</strong> –&gt; markets evolve</li>
<li><strong>interference</strong> –&gt; [government] interference</li>
<li><strong>development</strong> –&gt; [market] develops</li>
</ul>
</li>
<li>[<strong>Result</strong>]: When a government intervenes in fast-changing technologies, it distorts how markets evolve and interferes with their ability to develop new products.</li>
</ol>
</li>
</ul>
<h2 id="Reconstructing-absent-characters"><a href="#Reconstructing-absent-characters" class="headerlink" title="Reconstructing absent characters"></a>Reconstructing absent characters</h2><p>In English, there’s just no universal good ways to name a generic “doer”. Most times you need to invent the approprieate doer in regards to the context. But if one can pinpoint the exact doer, you have found the main character and can use it to avoid nominalizations.</p>
<p>If the hidden characters are “people in general”, try a general term for whoever is doing the action, such as <em>researchers</em>, <em>one</em>, <em>scientists</em>, and so on. If not, try <em>we</em>.</p>
<p>When you are explaining a complicated issue to someone involved in it, imagin sitting across the table from that person, saying <em>you</em> as often as you can. If <em>you</em> seems inapppropriate, change it to some general character.</p>
<ul>
<li>[<strong>ORIGINAL</strong>]: Taxable intangible property includes financial notes and municipal bonds. A one-time tax of 2% on its value applies to this property.</li>
<li>[<strong>YOU</strong>]: <strong>You</strong> have to pay tax on your intangible property, including <strong>your</strong> financial notes and municipal bonds. On this property, <strong>you</strong> pay a one-time tax of 2%.</li>
<li>[<strong>GENERAL</strong>]: <strong>Taxpayers</strong> have to pay tax on your intangible property, including <strong>Their</strong> financial notes and municipal bonds. On this property, <strong>they</strong> pay a one-time tax of 2%.</li>
</ul>
<h3 id="Abstraction-as-characters"><a href="#Abstraction-as-characters" class="headerlink" title="Abstraction as characters"></a>Abstraction as characters</h3><p>You can tell stories whose main characters are abstractions, including nominalizations, so long as you make them the subjects of verbs that tell a story. In addition, avoid using lots of other abstract nominalizations around them.</p>
<ul>
<li>[<strong>BAD</strong>]: A nominalization is a <strong>replacement</strong> of a verb by a noun, often resulting in <strong>displacement</strong> of characters from subjects by nouns.</li>
<li>[<strong>GOOD</strong>]: When a nominalization <strong>replaces</strong> a verb with a noun, it often <strong>diplaces</strong> characters from subjects.</li>
</ul>
<h2 id="Characters-and-passive-verbs"><a href="#Characters-and-passive-verbs" class="headerlink" title="Characters and passive verbs"></a>Characters and passive verbs</h2><h3 id="Choosing-between-active-and-passive"><a href="#Choosing-between-active-and-passive" class="headerlink" title="Choosing between active and passive"></a>Choosing between active and passive</h3><p>Ask three questins:</p>
<ol>
<li><strong>Must your readers know who is responsible for the action?</strong><br>Use passive if you don’t know who did an action, readers don’t care, or you don’t want them to know.</li>
<li><strong>Would the active or passive verb help your readers move more smoothly from one sentence to the next?</strong><br>Use passive if you want to shift a long and complex bundle of information to the end of a sentence, especially when doing so also lets you begin with a chunk of information that is shorter, more familiar, and therefor easier to understand. (the <em>old-before-new</em> principle)</li>
<li><strong>Would the active or passive give readers a more consistent and appropriate point of view?</strong><br>Use passibe if you want to focus your readers’ attention on one or another character. <strong>When telling one story</strong>, try to use the same main character between sentences. Pick a point of view and stick to it. (the <em>cohesion and coherence</em> principle)</li>
</ol>
<h3 id="Passive-v-s-I-We"><a href="#Passive-v-s-I-We" class="headerlink" title="Passive v.s. I/We"></a>Passive v.s. I/We</h3><p>In academic writing, it’s ok to use <em>We/I</em> when describing verbs that name actions unique to the writer. Still, you’d better use it in certain ways:</p>
<ol>
<li>Use an active verb if it is a <em>metadiscourse</em> verb. Metadiscourse is language that refers not to the substance of your ideas, but to yourself, your reader, or your writing.<ul>
<li>your thinking and act of writing: <em>We will explain, show, argue, claim, deny, suggest, contrast, add, expand, summarize</em> …</li>
<li>your readers’ actions: <em>consider now, as you recall, look at the next example</em> …</li>
<li>the logic and form of what you have written: <em>first, second; to begin; therefore, however, consequently</em></li>
</ul>
</li>
<li>Use passive verb if it’s specific actions performed as part of the research, actions that anyone can perform: <em>measure, record, examine, observe, use</em>.</li>
<li>Sometimes using passive verbs may produce dangling modifiers (the introductory phrase has an <em>implied</em> subject that differs from the <em>explicit</em> subject in the following clause), but in scientific writings these patterns are so common that it has become standard usage in the community.<ul>
<li>[<strong>EXAMPLE</strong>] To determine if monokines elicited a response, preparations of … WERE ADDED.</li>
<li>The implied subject is <strong>I</strong>, while the explicit subject is <strong>preparation</strong></li>
</ul>
</li>
</ol>
<h2 id="Clarity-and-the-professional-voice"><a href="#Clarity-and-the-professional-voice" class="headerlink" title="Clarity and the professional voice"></a>Clarity and the professional voice</h2><p>When possible, rewrite long compound noun phrases.</p>
<ul>
<li>[<strong>BAD</strong>]: We discussed the board candidate review meeting schedule.</li>
<li>[<strong>GOOD</strong>]: We discussed the schedule of meetings to review candidates for the board.</li>
</ul>
<p>If a long compound noun includes a technical term in your field, keep that part of the compound and unpack the rest.</p>
<p>When you read or write a style that seems complex, you must determine whether it needs to be so complex to express complex ideas precisely. </p>
<blockquote>
<p>A style should be as complex as necessary, but no more.</p>
</blockquote>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>Joseph M. Williams and Joseph Bizup, <a href="https://www.amazon.com/Style-Lessons-Clarity-Grace-11th/dp/0321898680" target="_blank" rel="external">Style: Lessons in Clarity and Grace (11th Edition)</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2017/06/05/notes-on-style-book-ch4/" data-id="cj3jfggxn0005xprl3fupjamz" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2017/06/05/notes-on-style-book-ch4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/style-lessons-in-clarity-and-grace/">style-lessons-in-clarity-and-grace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writing/">writing</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-notes-on-style-book-ch3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/19/notes-on-style-book-ch3/" class="article-date">
  <time datetime="2017-02-19T02:29:22.000Z" itemprop="datePublished">2017-02-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/english-writing/">english-writing</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/19/notes-on-style-book-ch3/">English writing - Actions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>This is the reading notes for book <em>Style - Lessons in Clarity and Grace</em></p>
</blockquote>
<hr>
<p>After writing several papers and inundated with reviewers’ criticism, I realized how bad my english writing is. This is my first reading notes of the book <em>Style: Lessons in Clarity and Grace</em>. Hope I can finish this book.</p>
<h2 id="Two-major-principles-of-clarity"><a href="#Two-major-principles-of-clarity" class="headerlink" title="Two major principles of clarity"></a>Two major principles of clarity</h2><ul>
<li>Make main characters the subjects of your verbs;</li>
<li>Make those characters’ important actions your verbs: </li>
<li>Examples:<ul>
<li>[<strong>BAD</strong>]: The <em>cause</em> of <strong>our schools</strong>‘ failure at teaching basic skills IS not <strong>understanding</strong> the <strong>influence</strong> of <strong>cultural background</strong> on learning.</li>
<li>[<strong>GOOD</strong>]: <strong><em>Our schools</em></strong> HAVE <strong><em>FAILED</em></strong> to teach basic skills because they do not <strong><em>UNDERSTAND</em></strong> how <strong><em>cultural background</em></strong>  <strong><em>INFLUENCES</em></strong> the way a child learns.</li>
</ul>
</li>
</ul>
<h2 id="Verbs-and-Actions"><a href="#Verbs-and-Actions" class="headerlink" title="Verbs and Actions"></a>Verbs and Actions</h2><blockquote>
<p>A sentence seems clear when its important actions are in verbs.</p>
</blockquote>
<ul>
<li>Nominalization is the root of evil.<ul>
<li>It makes writing more abstract and indirect.</li>
<li>It prevents reader from identifying the main character and actions.</li>
</ul>
</li>
</ul>
<h2 id="Diagnosis-and-Revision-Characters-and-Actions"><a href="#Diagnosis-and-Revision-Characters-and-Actions" class="headerlink" title="Diagnosis and Revision: Characters and Actions"></a>Diagnosis and Revision: Characters and Actions</h2><ul>
<li>Diagnosis<ol>
<li>Ignoring short introductory phrases, <strong>underline the first seven or eight words in each sentence</strong>.</li>
<li>Then look for two results:<ul>
<li>You underlined abstract nouns as simple subjects.</li>
<li>You underlined seven or eight words before getting to a verb.</li>
</ul>
</li>
</ol>
</li>
<li>Analyze<ol>
<li>Decide who your main charaters are, particularly <em>the flesh-and-blood ones</em></li>
<li>Look for the actions that those characters perform, especially actions in nominalizations.</li>
</ol>
</li>
<li>Rewrite<ol>
<li>Make nominalizations verbs.</li>
<li>Make the characters the subjects of those verbs.</li>
<li>Rewrite the sentence with subordinating conjunctions such as <em>because, if, when, thought</em>, etc.</li>
</ol>
</li>
</ul>
<h2 id="Common-Patterns-of-Nominalizations"><a href="#Common-Patterns-of-Nominalizations" class="headerlink" title="Common Patterns of Nominalizations"></a>Common Patterns of Nominalizations</h2><ul>
<li>Subject of an empth verb such as <em>be, seems, has</em>, etc.<ul>
<li>Example: The <strong>intention</strong> of the committee IS to audit the records</li>
</ul>
</li>
<li>Follows an empty verb.<ul>
<li>Example: The agency CONDUCTED and <strong>investigation</strong> into that matter.</li>
</ul>
</li>
<li>Combination of the above two.</li>
<li>Follows <em>there is</em> or <em>there are</em>.<ul>
<li>Example: There IS no <strong>need</strong> for our further <strong>study</strong> of this problem.</li>
</ul>
</li>
<li>Two or three nominalizations joined by prepositions.<ul>
<li>Example: We did a <strong>review</strong> of the <strong>evolution</strong> of the brain</li>
</ul>
</li>
</ul>
<h2 id="Useful-Nominalizations"><a href="#Useful-Nominalizations" class="headerlink" title="Useful Nominalizations"></a>Useful Nominalizations</h2><p>Nominalizations are properly used if</p>
<ul>
<li>It’s a short subject that refers to a previous sentence:<ul>
<li><strong>These arguments</strong> all depend on a single unproven claim.</li>
</ul>
</li>
<li>It replaces an awkward <em>the fact that</em>:<ul>
<li>[<strong>BAD</strong>]: The fact that she <strong>ADMITTED</strong> guilt impressed me.</li>
<li>[<strong>GOOD</strong>]: Her admission of guilt impressed me.</li>
</ul>
</li>
<li>It names what would be the object of the verb:<ul>
<li>[<strong>BAD</strong>]: I accepted what she <strong>REQUESTED</strong>.</li>
<li>[<strong>GOOD</strong>]: I accepted her <strong>request</strong>.</li>
</ul>
</li>
<li>It refers to a concept so familiar to readers (i.e. common ideas):<ul>
<li>The Equal Rights <strong>Amendment</strong> was an issue in past <strong>elections</strong></li>
</ul>
</li>
</ul>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>Joseph M. Williams and Joseph Bizup, <a href="https://www.amazon.com/Style-Lessons-Clarity-Grace-11th/dp/0321898680" target="_blank" rel="external">Style: Lessons in Clarity and Grace (11th Edition)</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2017/02/19/notes-on-style-book-ch3/" data-id="cj3jfan6o0000xprlbk9yw3xm" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2017/02/19/notes-on-style-book-ch3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/style-lessons-in-clarity-and-grace/">style-lessons-in-clarity-and-grace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writing/">writing</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-chernoff-hoeffding" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/22/chernoff-hoeffding/" class="article-date">
  <time datetime="2016-09-22T02:29:22.000Z" itemprop="datePublished">2016-09-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Math/">Math</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/22/chernoff-hoeffding/">Chernoff-Hoeffding Bound</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h2><p>中心不等式（Concentration Inequality）是分析随机算法的经典工具，在机器学习算法的理论分析中也用的特别多。为了学习这方面的知识，刚开始我选择的是Massart和Lugosi所著的<a href="http://book.douban.com/subject/20500140/" target="_blank" rel="external">Concentration Inequalities</a>，无奈数学水平不够，看了一章就实在看不下去了。后来换了本简单一些的<a href="http://book.douban.com/subject/4563191/" target="_blank" rel="external">Concentration of Measure for the Analysis of Randomized Algorithms</a>，总算是能往后翻了。这个系列的文章作为该书的读书笔记，希望能够督促自己坚持读完。</p>
<p>Concentration of meature可简单地理解为随机变量在其期望处“聚集”的行为。概率论中已经提供了两个经典工具————大数定律及中心极限定理————来刻画这种现象，然而它们所给出的结果存在几点不足：</p>
<ul>
<li>上述结果只刻画了渐进情况下的性质，然而在分析实际算法时我们更青睐能够应用于finite case的结果</li>
<li>上述经典工具给出的是qualitative的结果，但我们更希望有quantitative的结果，也即明确的收敛率</li>
<li>上述经典工具给出的结果都基于独立性的假设，然而对于很多复杂的随机算法，独立性是不满足的，因此我们需要不依赖独立性假设的工具。</li>
</ul>
<h2 id="Chernoff-Bound"><a href="#Chernoff-Bound" class="headerlink" title="Chernoff Bound"></a>Chernoff Bound</h2><p>Chernoff bounding technique指的是用moment-generating function来处理多个随机变量之和的期望的技巧。所谓moment-generating function被定义为随机变量$X$的指数函数的期望$E[e^{\lambda X}]$。</p>
<p>先来看一个简单的例子：考虑<strong>独立同分布</strong>的Bernoulli随机变量 $X_i\sim \text{Bernoulli}(p)$ 及它们的和$X=\sum_{i\in[n]}X_i$，易见$X_i\sim \text{Binomial}(n, p)$。现在要估计$X$偏离其期望一定距离的概率，即$\Pr[X&gt;n(p+t)]$. 先考虑一个一般性的情况：估计$\Pr[X&gt;m]$. 由Markov不等式易得</p>
<p>$$<br>\begin{align}<br>\Pr[X&gt;m] &amp;= \Pr[e^{\lambda X}&gt;e^{\lambda m}] \\<br>&amp;\leq \frac{E[e^{\lambda X}]}{e^{\lambda m}}<br>\end{align}<br>$$</p>
<p>根据$X_i$的独立性，上述式子中的moment-generating function可写成</p>
<p>$$<br>\begin{align}<br>E[e^{\lambda X}] &amp;= E[e^{\lambda\sum_i X_i}] \\<br>&amp;= E[\prod_i e^{\lambda X_i}] \\<br>&amp;= \prod_i E[e^{\lambda X_i}] \\<br>&amp;= (pe^\lambda+q)^n<br>\end{align}<br>$$</p>
<p>其中$q=1-p$.再令$m=(p+t)n$，原不等式变为</p>
<p>$$\Pr[X&gt;m]\leq\left(\frac{pe^\lambda+q}{e^{\lambda(p+t)}}\right)^n$$</p>
<p>将上述不等式右边视为$\lambda$的函数，找一个$\lambda&gt;0$使右边最小，由此我们得到基本的Chernoff bound：</p>
<p>$$<br>\begin{align}<br>\Pr[X&gt;(p+t)n] &amp;\leq \left(\left(\frac{p}{p+t} \right)^{p+t} \left(\frac{q}{q-t}\right)^{q-t}\right)^n \\<br>&amp;= \left[\text{exp}\left(-(p+t)\text{ln}\frac{p+t}{p}-(q-t)\text{ln}\frac{q-t}{q}\right)\right]^n \\<br>&amp;= \text{exp}\left(-nD_{KL}(p+t||p)\right)<br>\end{align}<br>$$</p>
<p>其中$D_{KL}(\cdot||\cdot)$是<a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence" target="_blank" rel="external">KL-Divergence</a>.上述bound说明，当实际分布（的参数）是$(p,q)$时，观测到经验分布$(p+t,q-t)$的概率随着样本大小$n$的增加指数下降，且下降速率与实际分布及经验分布的KL-Divergence密切相关。</p>
<h2 id="Chernoff-Hoeffding-bound"><a href="#Chernoff-Hoeffding-bound" class="headerlink" title="Chernoff-Hoeffding bound"></a>Chernoff-Hoeffding bound</h2><p>之前Chernoff bound的推导是在$X_i$为独立同分布的Bernoulli随机变量的假定下进行的，现在我们把上述bound推广到$X_i$是<strong>任意$[0,1]$间的独立随机变量</strong>的情况。首先考虑$X_i$是独立但<strong>非</strong>同分布的Bernoulli随机变量的情况。此时$X$的moment-generating function变为</p>
<p>$$E[e^{\lambda X}] = \prod_i(p_ie^\lambda+q_i)$$</p>
<p>根据<a href="https://en.wikipedia.org/wiki/Inequality_of_arithmetic_and_geometric_means" target="_blank" rel="external">Arithmetic-Geometric Mean Inequality</a>易得</p>
<p>$$<br>\begin{align}<br>E[e^{\lambda X}] &amp;= \prod_i(p_ie^\lambda+q_i) \\<br>&amp;\leq\left(\frac{\sum_i(p_ie^\lambda+q_i)}{n}\right)^n \\<br>&amp;= (pe^\lambda+q)^n<br>\end{align}<br>$$</p>
<p>其中$p=\sum_ip_i/n, q=1-p$. 易见此时bound又变回了之前独立同分布时的形式，因此上一节得到的bound依然成立。</p>
<p>接下来考虑$X_i$是$[0,1]$上任意（既可以是离散也可以是连续的）独立随机变量的情况，使用的技巧是由Hoeffding提出的，因此最后得到的bound也叫Chernoff-Hoeffding bound。这里要利用函数$e^{\lambda x}$的凸性：在区间$[0,1]$上，$e^{\lambda x}$的图像总在连接点$(0,1)$及$(1,e^\lambda)$的直线之下。该直线的方程为$y=(e^\lambda-1)x+1$，因此有</p>
<p>$$E[e^{\lambda X_i}] \leq E[(e^\lambda-1)X_i+1] = p_ie^\lambda+q_i$$</p>
<p>故有</p>
<p>$$E[e^{\lambda X}] \leq \prod_i E[e^{\lambda X_i}] \leq \prod_i(p_ie^\lambda+q_i)$$</p>
<p>这与前述$X_i$是独立非同分布Bernoulli随机变量的情况一致，因此上一节得到的bound依然成立。</p>
<h2 id="Variance-bound"><a href="#Variance-bound" class="headerlink" title="Variance bound"></a>Variance bound</h2><p>之前得到的bound都只利用了一阶矩（期望）的信息，作为Chernoff bounding technique的一个简单应用，我们考虑引入二阶矩（方差）的信息。这里的关键技巧是利用不等式$e^x\leq1+x+x^2, (0&lt;|x|&lt;1)$为moment-generating function构造上界，从而引入二阶矩（$x^2$）。设$\mu_i=E[X_i], \mu=E[X]$，易知</p>
<p>$$<br>\begin{align}<br>\Pr[X&gt;\mu+t] &amp;= \Pr[\sum_i(X_i-\mu_i)&gt;t] \\<br>&amp;= \Pr[e^{\lambda\sum_i (X_i-\mu_i)}&gt;e^{\lambda t}] \\<br>&amp;\leq E[e^{\lambda\sum_i(X_i-\mu_i)}]/e^{\lambda t}<br>\end{align}<br>$$</p>
<p>利用之前提到的不等式及$e^x\geq1+x$，并假设$\forall i\in[n], \text{max}(\mu_i,1-\mu_i)&lt;1/\lambda$，有</p>
<p>$$<br>\begin{align}<br>E[e^{\lambda\sum_i(X_i-\mu_i)}] &amp;= \prod_iE[e^{\lambda(X_i-\mu_i)}] \\<br>&amp;\leq \prod_i E[1+\lambda(X_i-\mu_i)+\lambda^2(X_i-\mu_i)^2] \\<br>&amp;= \prod_i(1+\lambda^2\sigma_i^2) \\<br>&amp;\leq \prod_ie^{\lambda^2\sigma_i^2} \\<br>&amp;= e^{\lambda^2\sigma^2}<br>\end{align}<br>$$</p>
<p>其中$\sigma_i^2,\sigma^2$分别是$X_i,X$的方差。综上，有</p>
<p>$$\Pr[X&gt;\mu+t] \leq e^{\lambda^2\sigma^2}/e^{\lambda t}$$</p>
<p>针对$\lambda&lt;\text{max}(\mu_i,1-\mu_i)$最小化该上界，易知当$\lambda=t/2\sigma^2$时有</p>
<p>$$\Pr[X&gt;\mu+t] \leq \text{exp}\left(\frac{-t^2}{4\sigma^2}\right)$$</p>
<p>其中$t&lt;2\sigma^2/(\text{max}_i\ \text{max}(\mu_i, 1-\mu_i))$</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/09/22/chernoff-hoeffding/" data-id="cj3ebn2uk000f5z4k925vl83n" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/09/22/chernoff-hoeffding/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/math/">math</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mit-distributed-system-course-summary" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/26/mit-distributed-system-course-summary/" class="article-date">
  <time datetime="2016-03-26T02:29:22.000Z" itemprop="datePublished">2016-03-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/26/mit-distributed-system-course-summary/">Summary for MIT 6.824- Course projects</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>从去年国庆节的时候开始刷MIT的分布式系统课程，到3月初的时候终于断断续续地把作业都做完了。刷了这个课才终于知道为什么美帝的小伙伴们一个学期最多就选个三门课了——作业又多又难，选多了铁定要跪。就比如这门6.824，从头至尾读了几十篇论文，写的代码比我之前一个学期的代码总量都多。反观自己在国内选修的一些课程，大部分都水的不能看，纯粹混学分，一个学期可以修四五门，简直药丸。</p>
<p>这篇文章主要记录了我在做作业时碰到的一些坑。可能还有一些坑我自己都没发现，毕竟分布式系统设计中有很多subtle的地方，尤其是涉及某些分布式一致性算法时（没错我就是在吐槽Paxos），各个节点间应交换哪些信息、针对不同的信息应做何种处理都很有门道，绝对不能靠想当然，否则你总会发现自己莫名其妙的就破坏了一致性。另外调试这种程序基本只能靠把日志打印出来一条条分析，若对算法没有非常清晰的认识、知道什么该发生什么不该发生，那从日志里也不可能看出什么有用的东西。</p>
<h1 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h1><h2 id="Preliminary-of-MapReduce"><a href="#Preliminary-of-MapReduce" class="headerlink" title="Preliminary of MapReduce"></a>Preliminary of MapReduce</h2><ul>
<li>三个阶段：Map–&gt;Merge–&gt;Reduce</li>
<li>Map在Mapper上进行， Merge和Reduce则都在Reducer上进行</li>
<li>Reducer的数目不能太多，因为Mapper生成的中间文件的数目是#Mapper * #Reducer</li>
<li>所有Mapper<strong>共用</strong>一个hash function来把不同的key映射到其对应的Reducer，因此保证最后相同的key会集中到同一个Reducer上</li>
</ul>
<h2 id="Main-problem-the-RunMaster-function-in-master-go"><a href="#Main-problem-the-RunMaster-function-in-master-go" class="headerlink" title="Main problem: the RunMaster() function in master.go"></a>Main problem: the <code>RunMaster()</code> function in <code>master.go</code></h2><p>这个函数的主要作用是分配、调度任务，在用户指定了Map任务的数目<code>nMap</code>和Reduce任务的数目<code>nReduce</code>后，分配足够的worker来完成任务。注意这里我说的是“任务的数目”，而不是“Worker”的数目：因为实际上<code>nMap</code>和<code>nReduce</code>可以任意指定，这个只影响生成的中间文件的数目，然而系统中worker的总数是固定的（且完全可能小于<code>nMap</code>和<code>nReduce</code>），这就意味着<strong>在某个worker完成一项任务后，需要调度它去完成剩余的任务</strong>，worker的角色只由它分配到的任务决定，一个worker可以先是Mapper然后又变成了Reducer。相比于实际中的MapReduce系统，这里没有考虑“Move computation to data”的就近原则。</p>
<p>主要的实现思想：在Map阶段，<code>RunMaster()</code>函数持续地从<code>mr.availableWorkers</code>这个channel中获取idle worker的名字，然后让它去完成一个Map任务，在worker完成任务后，由把它重新加到<code>mr.availableWorkers</code>中去。上述操作通过创建一个goroutine来完成，因此这个调度过程是并发的。Reduce步骤的方法类似。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Handle out Map jobs in parallel</span></div><div class="line">taskDoneChannel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">for</span> m := <span class="number">0</span>; m &lt; mr.nMap; m++ &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">		jobArgs := DoJobArgs&#123; ... &#125;</div><div class="line">		<span class="keyword">var</span> reply DoJobReply</div><div class="line"></div><div class="line">		ok := <span class="literal">false</span></div><div class="line">		worker := &lt;-mr.availableWorkers</div><div class="line">		ok = call(worker, <span class="string">"Worker.DoJob"</span>, &amp;jobArgs, &amp;reply)</div><div class="line">		<span class="keyword">for</span> ok != <span class="literal">true</span> &#123;</div><div class="line">			<span class="comment">// if worker failed, set it available and switch to another one</span></div><div class="line">			<span class="keyword">go</span> setAvailable(worker)</div><div class="line">			worker = &lt;-mr.availableWorkers</div><div class="line">			ok = call(worker, <span class="string">"Worker.DoJob"</span>, &amp;jobArgs, &amp;reply)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// if worker succeed, set it available</span></div><div class="line">		<span class="keyword">go</span> setAvailable(worker)</div><div class="line">		taskDoneChannel &lt;- <span class="number">1</span></div><div class="line">	&#125;(m)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ensure all map tasks being completed</span></div><div class="line"><span class="keyword">for</span> m := <span class="number">0</span>; m &lt; mr.nMap; m++ &#123;</div><div class="line">	&lt;-taskDoneChannel</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Primary-Backup-Key-Value-Service"><a href="#Primary-Backup-Key-Value-Service" class="headerlink" title="Primary/Backup Key/Value Service"></a>Primary/Backup Key/Value Service</h1><p>主要分成两个部分：</p>
<ul>
<li>viewservice server，作为全局的coordinator，维护并更新当前view的情况（主要包括view number、当前primary server、当前backup server）；这里假设viewservice server永远不会崩溃。</li>
<li>Key/Value server，用来保存数据，一般情况下有两个——primary和backup，primary响应各种对数据的读写请求，backup则作为primary的副本，在primary崩溃时接管服务。</li>
</ul>
<h2 id="View-service"><a href="#View-service" class="headerlink" title="View service"></a>View service</h2><p>viewservice server给primary及backup server分别维护一个counter，周期性地increment这两个counter，同时在收到heartbeat消息时把相应的counter清零。每隔counter的大小就表示viewservice server有多久没有收到heartbeat消息了。</p>
<p>主要的功能集中在两个地方：<code>Ping()</code> RPC handler，用来接收heartbeat消息，返回当前最新的view，并为primary或者backup把counter清零；<code>tick()</code>，自身的一个计时程序，周期性地在后台执行，每次执行都增加counter值。</p>
<p>其实并没有什么特别大的坑，只要把各种细节情况考虑周全即可，包括：</p>
<ul>
<li>Primary/backup 是否存在</li>
<li>若primary/backup存在，当其中一个/两个挂掉的时候该如何更新view</li>
</ul>
<h2 id="Primary-backup-service"><a href="#Primary-backup-service" class="headerlink" title="Primary/backup service"></a>Primary/backup service</h2><p>Primary server就是个字典，保存了一些key/value pair，然后把数据在backup server上replicate了一份；它提供<code>Get(key)</code>、<code>Put(key, value)</code>，及<code>Append(key, value)</code>三类操作。这里是第一次实现不同节点间的数据同步，虽然只是两个节点。</p>
<p>主要的坑有三个：</p>
<h3 id="过滤重复的RPC"><a href="#过滤重复的RPC" class="headerlink" title="过滤重复的RPC"></a>过滤重复的RPC</h3><p>设想客户端发了一个RPC请求（例如一个<code>Append</code>请求），服务端接到请求之后完成相应的操作，然而在服务端正要通知客户端请求完成的时候网络连接挂掉了，这时客户端由于不知道之前的<code>Append</code>操作已经完成，会重新发送，因此必须把这个重复的<code>Append</code>请求过滤掉。</p>
<p>对于幂等的操作<code>Get</code>，由于它不改变数据状态，因此不需要过滤重复请求——事实上也不应过滤，因客户端仅当没收到答复时才会重新发送请求，而<code>Get</code>操作的结果就包含在答复信息中。</p>
<p>为了过滤重复的RPC，服务端需要知道客户端的当前“状态”，因此我用了一个非常粗暴的方法：每个客户端维护一个序号<code>maxSeq</code>，在发出RPC请求时附上这个序号，<strong>请求成功后</strong>就把该序号加1。同时服务端为每个客户端分别维护一个序号，记录该客户端向其发送过的最大<code>maxSeq</code>，若收到RPC请求的序号小于服务端所维护的对应<code>maxSeq</code>，则说明该请求的内容已经被执行过，服务端就可以忽略之。</p>
<h3 id="view-change"><a href="#view-change" class="headerlink" title="view change"></a>view change</h3><p>由于view只由viewservice server管理，有可能出现primary和backup持有不同view的情况。而且这种view-splitting可能在任何时候出现。</p>
<h3 id="初始化新的backup"><a href="#初始化新的backup" class="headerlink" title="初始化新的backup"></a>初始化新的backup</h3><p>当一个idle server被提升成新的backup时，需要用primary的当前状态初始化它。我实现的时候选择了push的方法：即primary在发现新的backup出现后，把自己的数据和状态推送给它。也可以用pull的方式，让新的backup主动向primary索要数据。这里需要注意的也是view-splitting的问题。</p>
<h1 id="Paxos-based-Key-Value-Service"><a href="#Paxos-based-Key-Value-Service" class="headerlink" title="Paxos-based Key/Value Service"></a>Paxos-based Key/Value Service</h1><h2 id="Preliminary"><a href="#Preliminary" class="headerlink" title="Preliminary"></a>Preliminary</h2><p>Paxos算法简单地说来就是利用quorum + two-phase commit实现的一个consensus算法。Paxos算法中没有固定的leader，因此理论上来说有很好的容错性，因为没有哪个节点会成为critical path。</p>
<p>实验中假设每个节点都维护了各自的一个log，log中的每个条目称为一个instance，每个instance有两种状态：decided和undecided。若某个节点发现自己的log中有一个undecided instance <code>i</code>，则它可以为该instance提出（propose）一个值，当系统中一半以上的节点（quorum）都在某个值<code>v</code>上达成一致，instance <code>i</code>就被decided，且具有值<code>v</code>。注意多个节点允许同时为同一个instance提出不同的值，但Paxos算法保证，当系统中一半以上的节点都正常工作且能互相通信时：</p>
<ol>
<li>某个quorum最后一定能达到concensus</li>
<li>达成一致的值<code>v</code>一定是由某个节点提出的，也即一定有某个proposer成功了</li>
<li>一旦达成一致，instance <code>i</code>的值就不再改变，即系统不可能又为该instance确定一个新的值</li>
</ol>
<p>Paxos算法包含如下几个方面：<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"> --- Paxos Proposer ---</div><div class="line"></div><div class="line">proposer(v)<span class="symbol">:</span></div><div class="line">   while <span class="built_in">not</span> decid<span class="symbol">ed:</span></div><div class="line">     <span class="built_in">choose</span> <span class="built_in">n</span>, unique <span class="built_in">and</span> higher than any <span class="built_in">n</span> seen so far</div><div class="line">     send prepare(<span class="built_in">n</span>) to all servers including self</div><div class="line">     <span class="built_in">if</span> prepare_ok(<span class="built_in">n</span>, <span class="built_in">na</span>, va) from majori<span class="symbol">ty:</span></div><div class="line">       v' = va with highest <span class="built_in">na</span>; <span class="built_in">choose</span> own v otherwise   </div><div class="line">       send accept(<span class="built_in">n</span>, v') to all</div><div class="line">       <span class="built_in">if</span> accept_ok(<span class="built_in">n</span>) from majori<span class="symbol">ty:</span></div><div class="line">         send decided(v') to all</div><div class="line"></div><div class="line"> </div><div class="line"> --- Paxos Acceptor ---</div><div class="line"></div><div class="line">acceptor state on each node (persistent)<span class="symbol">:</span></div><div class="line">  np     --- highest prepare seen</div><div class="line">  <span class="built_in">na</span>, va --- highest accept seen</div><div class="line"></div><div class="line">acceptor's prepare(<span class="built_in">n</span>) handl<span class="symbol">er:</span></div><div class="line"> <span class="built_in">if</span> <span class="built_in">n</span> &gt; np</div><div class="line">   np = <span class="built_in">n</span></div><div class="line">   reply prepare_ok(<span class="built_in">n</span>, <span class="built_in">na</span>, va)</div><div class="line"> else</div><div class="line">   reply prepare_reject</div><div class="line"></div><div class="line"></div><div class="line">acceptor's accept(<span class="built_in">n</span>, v) handl<span class="symbol">er:</span></div><div class="line"> <span class="built_in">if</span> <span class="built_in">n</span> &gt;= np</div><div class="line">   np = <span class="built_in">n</span></div><div class="line">   <span class="built_in">na</span> = <span class="built_in">n</span></div><div class="line">   va = v</div><div class="line">   reply accept_ok(<span class="built_in">n</span>)</div><div class="line"> else</div><div class="line">   reply accept_reject</div></pre></td></tr></table></figure></p>
<h2 id="Problems-encountered-in-implementing-Paxos"><a href="#Problems-encountered-in-implementing-Paxos" class="headerlink" title="Problems encountered in implementing Paxos"></a>Problems encountered in implementing Paxos</h2><h3 id="prepare消息中带的ballot-number-n"><a href="#prepare消息中带的ballot-number-n" class="headerlink" title="prepare消息中带的ballot number n"></a><code>prepare</code>消息中带的ballot number <code>n</code></h3><p>之前的伪代码中说只要<code>n</code>是“unique and higher than any n seen so far”即可，然而由各个节点互相之间并不知道对方会选什么样的ballot number，因此必须有某种方式来保证<strong>不同节点一定会选择不同的ballot number</strong>，否则若两个节点选择了相同的<code>n</code>，就会出现splitting brain的情况，它们无法知道到底是自己的proposal成功了还是对方的proposal成功了。</p>
<p>由于实验中所有<em>N</em>个节点被事先编号为<em>0~N-1</em>，因此我让<em>k</em>号节点使用的ballot number <code>n</code>满足$n\ \text{mod}\ N = k$，这样就保证不同节点所使用的ballot number一定不同</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This function compute a unique ballot num for each paxos peer</span></div><div class="line"><span class="comment">// 1. this function works correctly IF AND ONLY IF all px.me's are distinct</span></div><div class="line"><span class="comment">//    and continuous, e.g. 0, 1, 2, 3, 4, 5</span></div><div class="line"><span class="comment">// 2. nb = min k s.t. k % px.population = px.me and k &gt; ballot</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(px *Paxos)</span> <span class="title">next_ballot</span><span class="params">(ballot <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> nb <span class="keyword">int</span></div><div class="line">	nb = ballot % px.population</div><div class="line">	nb = ballot - nb + px.me</div><div class="line">	<span class="keyword">if</span> nb &lt; ballot &#123;</div><div class="line">		nb += px.population</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nb</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Forget-already-decided-log-instance"><a href="#Forget-already-decided-log-instance" class="headerlink" title="Forget already decided log instance"></a>Forget already decided log instance</h3><p>之前所说的一个log instance的“值”，一般是某个客户端对服务端所提出的请求，例如对于一个分布式数据库，数据被replicate到多个节点上，则这些replica需要在对数据的操作上达成一致，也即有一个全局的顺序。当两个节点的log相同时，把log中记录的操作按顺序执行（commit）一遍后，这两个节点上的数据也一定是相同的。</p>
<p>由于log不能无限增长，这里实现的Paxos库提供删除instance的功能。注意如果要删除一个instance，必须系统中的<strong>所有</strong>节点都在该instance上达成一致，且该instance中记录的操作也已经被执行了。因为最后commit某个decided instance的时间可能发生在其decided之后的任意时刻，因此Paxos库把删除log的权利移交给使用该库的应用程序，仅当该应用程序主动提出要删除某个instance时，Paxos库才会<strong>试图</strong>删除该instance（这里用“试图”是因为可能存在某个节点仍然没有commit该instance，为了保证该节点在挂掉之后能够通过系统中其它节点正确地恢复数据，其它节点需要保留该instance，因此删除instance的操作并不总能成功）。</p>
<p>在实现时，由于instance的序号是单调增加的（log是单调增长的），Paxos库提供的<code>Done(seq)</code>操作实际上做的是宣布“本节点上所有序号小于等于<code>seq</code>的log instances都可以安全的删掉了”。当在节点<em>i</em>调用<code>Done(seq)</code>时，节点<em>i</em>向所有节点广播一条<code>forget(seq)</code>消息；若某个节点收到了系统中所有节点（包括它自身）的<code>forget(seq)</code>消息，它就把自己log中序号小于等于<code>seq</code>的instance删掉。</p>
<h2 id="Problems-encountered-when-implementing-a-distributed-key-value-store-based-on-Paxos"><a href="#Problems-encountered-when-implementing-a-distributed-key-value-store-based-on-Paxos" class="headerlink" title="Problems encountered when implementing a distributed key/value store based on Paxos"></a>Problems encountered when implementing a distributed key/value store based on Paxos</h2><h3 id="Using-a-single-state-machine-to-commit-log-instances"><a href="#Using-a-single-state-machine-to-commit-log-instances" class="headerlink" title="Using a single state machine to commit log instances"></a>Using a single state machine to commit log instances</h3><p>如果客户端的请求中没有<code>Get</code>这种获取数据当前状态的请求类型，因Paxos库支持并发的propose，完全可以用多个RPC handler并发地接收多个请求，然后用Paxos库把这些请求固化到log中，而commit log instance的工作则由某个后台进程周期性的执行。然而由于<code>Get</code>操作要求获取当时最新的数据状态，其对应的log instance在decide之后必须立刻commit，否则无法返回up-to-date的数据给客户端。</p>
<p>上述原因使得propose和commit两种操作耦合起来了，在允许并发propose的情况下会把情况搞得很复杂。为了简化实现，我使用一个单独的goroutine作为state machine统领上述两种类型的操作，具体为：所有RPC handler在接到请求之后，通过一个固定的channel把请求传给state machine，state machine负责用Paxos库propose该请求、并在需要时commit log中的decided instance。由于只有一个goroutine能操作数据和状态变量，几乎不用考虑并发的问题，连锁都用不上。但是相应的，程序的性能就降低了——服务端实际上变成了一个单线程的程序。</p>
<h1 id="Sharded-Key-Value-Service"><a href="#Sharded-Key-Value-Service" class="headerlink" title="Sharded Key/Value Service"></a>Sharded Key/Value Service</h1><h2 id="Shardmaster"><a href="#Shardmaster" class="headerlink" title="Shardmaster"></a>Shardmaster</h2><ul>
<li>角色：类似之前的viewservice，只是这里面对的是多个sharding group；</li>
<li>额外功能：用Paxos实现Fault tolerance；添加了load balance的功能，可以动态的添加删除sharding group，或者把某个key在不同的sharding group之间移动。</li>
</ul>
<h3 id="A-naive-load-balance-algorithm"><a href="#A-naive-load-balance-algorithm" class="headerlink" title="A naive load balance algorithm"></a>A naive load balance algorithm</h3><p>题目要求的是：</p>
<ol>
<li>使得sharding group间最大和最小负载的差不超过1个shard；</li>
<li>在rebalance的过程中移动的shard数目最少。在满足某个条件时，存在一个很naive的算法来实现上述要求：</li>
</ol>
<ul>
<li>当知道shard的总数$N$和sharding group的总数$G$时，就可以直接算出满足上述要求的shard分布：每个sharding group所host的shard数目必然是$\lfloor N/G\rfloor$或$\lfloor N/G\rfloor + 1$。因此，在加入新的sharding group或移除某个旧的sharding group时，可以直接计算出之后的load 分布情况，并依此决定移动shard的方式。</li>
<li><p>算法如下（假设原本有$G$个sharding group）：</p>
<ul>
<li><p>rebalance after <code>Join</code>:<br>新的sharding group的期望负载是$\lfloor N/(G+1)\rfloor$。将当前系统中的各sharding group按负载大小<strong>从高到低</strong>排序，依次从中各取一个shard移到新的sharding group中，不断循环，直到让新的sharding group达到期望负载，示例如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># N=10, G=3</span></div><div class="line"><span class="keyword">Before </span><span class="keyword">Join: </span><span class="built_in">a1</span>=<span class="number">4</span>, <span class="built_in">a2</span>=<span class="number">3</span>, <span class="built_in">a3</span>=<span class="number">3</span></div><div class="line">After <span class="built_in">a4</span> <span class="keyword">joins: </span><span class="built_in">a1</span>=<span class="number">3</span>, <span class="built_in">a2</span>=<span class="number">2</span>, <span class="built_in">a3</span>=<span class="number">3</span>, <span class="built_in">a4</span>=<span class="number">2</span></div></pre></td></tr></table></figure>
</li>
<li><p>rebalance after <code>Leave</code>:<br>将当前系统中的各sharding group按负载大小<strong>从低到高</strong>排序，然后从要移除的sharding group中按此顺序一个一个地将shard移交给其它group，直到把所有的shard移交完。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># N=10, G=4</span></div><div class="line"><span class="keyword">Before </span>Leave: <span class="built_in">a1</span>=<span class="number">3</span>, <span class="built_in">a2</span>=<span class="number">2</span>, <span class="built_in">a3</span>=<span class="number">3</span>, <span class="built_in">a4</span>=<span class="number">2</span></div><div class="line">After <span class="built_in">a4</span> leaves: <span class="built_in">a1</span>=<span class="number">3</span>, <span class="built_in">a2</span>=<span class="number">3</span>, <span class="built_in">a3</span>=<span class="number">4</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>若在某一时刻系统中的load分布满足之前的要求1</strong>，则在加入/移除某个sharding group后，通过上述算法得到的load分布仍然满足要求1，且移动的shard是最少的（即满足要求2）。因系统的初始状态（0个sharding group）是满足要求1的，故如果<strong>只有<code>Join</code>和<code>Leave</code>操作</strong>，则该算法可以保证系统的每个configuration都满足要求1，且rebalance过程移动最少的shard。注意这意味着当系统中的load分布不满足要求1时，上述算法不能保证达到负载均衡。</p>
</li>
<li>实现中碰到的坑：<code>Move</code>操作会打破负载均衡的状态，由于rebalance仅在<code>Join</code>/<code>Leave</code>后发生，算法可能会面对一个极不均衡的load分布，此时尽管算法无法使系统重新满足要求1，但可以减轻imbalance程度：例如在<code>Join</code>时，若某个existing sharding group的真实负载已经小于其期望负载，则在向新group移交shard时就跳过这个under-loaded group；<code>Leave</code>时的做法类似。</li>
</ul>
<h3 id="Load-balance-based-on-consistent-hashing"><a href="#Load-balance-based-on-consistent-hashing" class="headerlink" title="Load balance based on consistent hashing"></a>Load balance based on consistent hashing</h3><p>真实系统中使用的负载均衡算法一般基于consistent hashing，例子可以见Amazon的<a href="http://dl.acm.org/citation.cfm?id=1294281" target="_blank" rel="external">Dynamo论文</a>。由于其是基于hash的方法，无法达到作业要求的严格负载均衡（要求1），因此这里不详述。</p>
<h2 id="Sharded-Key-Value-Store"><a href="#Sharded-Key-Value-Store" class="headerlink" title="Sharded Key/Value Store"></a>Sharded Key/Value Store</h2><p>每个sharding group中的所有shard server组成一个replica group，分配给该group的shard在group中的每个server上都replicate一份。单个shard server的实现类似于之前基于Paxos的Key-Value store，额外的难点在于还要处理reconfiguration（load rebalance）的情况。</p>
<h3 id="Reconfiguration带来的坑"><a href="#Reconfiguration带来的坑" class="headerlink" title="Reconfiguration带来的坑"></a>Reconfiguration带来的坑</h3><p>这一部分的坑在于reconfiguration的时候，shard server如何处理普通的<code>Get</code>和<code>PutAppend</code>请求。很自然的做法是reconfiguration期间不接受任何其它请求，并通过Paxos把reconfiguration操作也固化到log中，从而使得整个shard group在“何时reconfiguration”这一事上达成一致。</p>
<p>由于reconfiguration会同时影响数据（某些Key会被移动）和状态（当前shard group host哪些shard），因此commit reconfiguration时也包含两个方面：其中对状态的影响应该在instance decided后<strong>立即</strong>commit，因为其会影响到对之后的所有请求的答复（例如当reconfiguration后某个key隶属的shard被移到其它group去了，那在这之后所有针对该key的请求都应该拒绝）；麻烦在于何时commit对数据的影响，因为不同的sharding group之间，对于reconfiguration的时间是没有一致性的，因此可能会出现下面几种问题：</p>
<ol>
<li>Group A发现在新的configuration中，有一些shard要从Group B移交给自己，然而Group B还没有看到这个新的configuration；</li>
<li>或Group A发现在新的configuration中，有一些shard要移交给Group B，然而Group B还没有看到这个新的configuration。</li>
<li>由于shardmaster能够通过<code>Move</code>操作在各个sharding group间任意移动shard，上述两种情况可能同时出现在Group A身上。</li>
<li>Group A中有个server $a_1$挂了好一会然后重启了，需要根据log来恢复数据状态，然而可能它挂的时候处于configuration $K_1$，而重启时Group B的configuration已经演进到了$K_2&gt;K_1+1$，此时若该server $a_1$在commit configuration $K_1+1$时需要向Group B获取shard S，那么：<ul>
<li>若shard S目前（即configuration $K_2$）不由Group B host，Group B该如何答复？</li>
<li>即使shard S目前正好由Group B host，Group B是否应该把它的当前值传递给$a_1$？要知道Group A中的其它没挂的server在commit configuration $K_1+1$时也向Group B索要过S，然而那时S对应的数据和现在所对应的数据完全可能不一样。</li>
</ul>
</li>
<li>对于“向其它group索要/移交shard”这个操作，是否有必要将其固化到Paxos的log中？</li>
</ol>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>对于上述问题，我设计了一个很低效的方法（但是能通过所有测试样例）：</p>
<ol>
<li>把每两个连续的configuration之间需要向其它group<strong>移交</strong>的数据做个快照（snapshot）存起来，这些快照按照configuration number来编号。</li>
<li>在向其它group索要shard时，附上对应的configuration number，被索要方根据configuration number返回对应的snapshot。若被索要方还没有做对应的snapshot，则拒绝请求。</li>
<li>在group之间转移shard时采用pull的方式：当commit reconfiguration请求时，若须向其它group索要shard，则当前server进入阻塞状态——重复索要直到成功获得数据为止；若只须向其它group移交数据，则仅把需要移交的数据快照保存起来，然后reconfiguration即可结束。</li>
<li>Shard server在向shardmaster查询configuration状态时，要保证查询的<strong>连续性</strong>：即若自身当前configuration number是$n$，则仅query $n+1$时的configuration。这样保证每个server都能看到所有发生的reconfiguration，从而保证数据快照的正确性。</li>
<li>每个shard server专门提供一个RPC handler用于向其它group<strong>移交</strong>shard，由于移交的都是快照，而<strong>快照一旦生成就不会再改变</strong>，因此该操作只需判断所需的快照是否存在，除此之外不会影响server的数据和状态，故没必要使用Paxos将该操作固化在log中。</li>
</ol>
<h1 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h1><p>这部分主要是让你给上一节的Sharded Key-Value Server增加failure recovery的功能：把数据和log保存在硬盘上，这样当节点重启后能够快速地恢复到崩溃前的状态。这个作业的主要难点在于需要persist的东西包括四种：server的数据、server的状态、Paxos的log、Paxos的状态。这四样东西直接必须相互consistent，否则重启后恢复出来的东西就有问题。其中Paxos作为一个底层库，按理来说其对自身log和状态的persistence不应该暴露给上层应用，作业中给的提示其实也在暗示这样做：每个Key单独存成一个文件，这样每commit一个log instance的同时就修改对应Key在硬盘上的文件。然而Key一多就会生成好多个文件，我觉得这样太傻逼了，就决心把所有的数据存在一个文件里，结果后来证明自己才是真正的傻逼。</p>
<p>这个作业远比我一开始想象的更难。在实现过程中，Google那篇关于Chubby的论文<a href="http://dl.acm.org/citation.cfm?id=1281103" target="_blank" rel="external">Paxos Made Live - An Engineering Perspective</a>给了我很大帮助。这种工业界的论文如果只是简单地看一遍的话，里面很多有价值的东西根本体会不到，只有当你做一个类似的系统/功能的时候，再回头看才会觉得“啊真漂亮”。</p>
<h2 id="Basic-ideas"><a href="#Basic-ideas" class="headerlink" title="Basic ideas"></a>Basic ideas</h2><p>之前提到我打算把一个server的所有key-value数据都存在一个文件里，这个决定直接影响了后续的整个实现方式。对于正在工作的shard server，数据（也就是Key/Value pair）是以字典的形式存在内存里的，而字典是没有顺序的。如果在每commit一个log instance后，就修改相应key在硬盘上的内容，为了在那个数据文件里找到这个key的位置，将不得不把整个文件扫一遍——这个光是听起来就很傻，所以我做了第二个重要的设计决定：用一个后台进程定期地给整个数据库做快照（snapshot），然后用新的快照代替老的快照。由于快照过程和底层工作的Paxos进程是独立的，为了保证二者的一致性，我采取了Google论文里描述的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// acquire lock to freeze the server</span></div><div class="line">kv.state_mu.Lock()</div><div class="line"></div><div class="line"><span class="comment">// ask paxos for snapshot handler</span></div><div class="line">px_state := kv.px.CaptureState()</div><div class="line"></div><div class="line"><span class="comment">// take snapshot of current server state</span></div><div class="line">kv_state := kv.CaptureState()</div><div class="line"></div><div class="line"><span class="comment">// store snapshot on the disk</span></div><div class="line"><span class="keyword">if</span> err := kv.save_state(&amp;kv_state, &amp;px_state); err != <span class="literal">nil</span>&#123;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// tell paxos to eleminate log before the snapshotted point</span></div><div class="line"><span class="keyword">if</span> err := kv.px.Truncate(kv_state.CommittedPoint); err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// snapshot finished, release lock</span></div><div class="line">kv.state_mu.Unlock()</div></pre></td></tr></table></figure>
<p>说明</p>
<ol>
<li><p>快照和Paxos log之间必须保持consistent，因此server在制作快照时，必须知道所提取的快照在log中的相对位置。故在制作快照的第一步，server先向底层的Paxos库索取一个snapshot handler（实际上就是让Paxos给自己的状态拍一个快照，主要是此时对应的最大commited instance number，也即当前快照对应的instance在log中的位置），这个snapshot handler将一并保存在server的快照中。在server从崩溃中恢复时，它利用这个snapshot handler确定自己在paxos log中的位置。</p>
</li>
<li><p>由于Paxos自身也会将log写在硬盘上，当server的快照完成之后，其对应的时间点之前的log文件其实就可以删掉了。因此server可以显式地要求Paxos清理无用的log文件（这有点类似之前的<code>Paxos.Done</code>功能，只不过那时是释放内存空间，现在是释放硬盘空间）。</p>
</li>
<li><p>在某个server重启并试图恢复状态时，其可能需要向其余server索取某些已经不存在的log内容，这时由于这些log已经从硬盘上删掉了，没人能帮助它恢复。此时这个重启的server应该向其余server索要它们的快照，然后用这些快照重新初始化自己的数据和状态。</p>
</li>
<li><p>server的快照和Paxos的log是分开保存的，在重启时也要分别初始化这二者。</p>
</li>
</ol>
<h2 id="Modification-to-Paxos-library"><a href="#Modification-to-Paxos-library" class="headerlink" title="Modification to Paxos library"></a>Modification to Paxos library</h2><p>需要为Paxos库增加两个功能：</p>
<ol>
<li><p><code>save_log_entry(seq)</code>：把序号为<code>seq</code>的log instance写到磁盘上。这里需要考虑的问题是当一个instance处于何种状态的时候才能把它写到磁盘上：肯定不是undecided的时候，那应该是decided还是commited之后呢？由于当一个log instance被decided之后，服务端就可以答复客户端了（这里是针对<code>PutAppend</code>操作而言），此时在外界看来这个log instance里包含的请求就已经完成了，故为了保证这种对外的一致性在server重启后能得到恢复，一旦一个instance被decide，Paxos就立刻把它写到硬盘上。</p>
</li>
<li><p><code>Truncate(seq)</code>：上层的server application可以显示地调用这个函数来要求Paxos清理序号小于<code>seq</code>的log文件。注意这里不同于<code>Paxos.Done</code>，<code>Paxos.Truncate</code>一旦被调用，就一定会释放自己硬盘上的空间，这个过程中不会考虑其它节点的情况。此外，它也不考虑这个instance是否还存在于内存中——因此完全可能出现这种情况：某个log instance在硬盘上的记录已经被清理了，但它还存在于内存中（即还没有被<code>Forget</code>清理）。</p>
</li>
</ol>
<h2 id="Problems-encountered"><a href="#Problems-encountered" class="headerlink" title="Problems encountered"></a>Problems encountered</h2><p>主要的问题都发生在崩溃恢复阶段：</p>
<ol>
<li>server A通过自己硬盘上的快照恢复之后，需要向同group的其它peer server获取在其崩溃期间产生的decided log instance来把自己的状态更新到与其它server一致，若其它server 在A崩溃的这段时间里一直正常工作，则它们的<strong>内存</strong>中会保有A需要的全部log内容，这是由下述关系所保证的：<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A.maxDecided &gt;= A.committedPoint &gt;= others.globalMinUnForgotten</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这是最好的情况，A可以直接通过不断地propose empty value来获取其它server的decided log instance，从而逐渐地补全自己的log。</p>
<ol>
<li><p>若在server A崩溃的那段时间里，其它的server也都经历了崩溃，这使得A想要补齐的log instance可能已经永远丢失了——内存里的都没了，硬盘上的也被truncate掉了。这时server A可以判断出自己的状态和数据已经过于落后了，因此A应该向其它server索要它们的server snapshot及paxos log snapshot，然后用这些新的snapshot替换自身的snapshot，并重启server及paxos。</p>
</li>
<li><p>如果server A在参与关于log instance <em>K</em>的某轮Paxos proposal的过程中崩溃了，那当A重启后，它不能再次参与任何关于instance <em>K</em>的proposal：因为A在崩溃前可能已经向某个server做出了<code>Promise</code>或<code>AcceptOK</code>，然而在重启后A无法知道自己曾经做出过的答复（Paxos不会把undecided instance写到硬盘），这时如果A又参与同一轮proposal，则其可能会错误地向另一个server做出<code>Promise</code>或<code>AcceptOK</code>，即“A incorrectly change its mind”，这会彻底破坏Paxos算法的结果，使得整个系统失去一致性。<br>然而，由于A不可能通过快照获知自己在崩溃前是否参与了某个proposal，其必须通过某种方法从其它server处获取该信息。<br>为了解决上述问题，我让每个server维护一个变量<code>highestSeqSeen</code>，保存其见过的最大的log instance seq number（no matter whether it is decided or not），当A重启后，</p>
<ul>
<li>其首先令自身的Paxos进入一个“Freezed”状态，在该状态下，Paxos忽略所有<code>Prepare</code>和<code>Accept</code>请求；</li>
<li>然后，A向group中的quorum获取它们的<code>highestSeqSeen</code>，取其中的最大值$H$；</li>
<li>接下来，A不断地propose empty instance，直到把序号小于等于$H$的log instance都给decide；</li>
<li>最后，A给自身的Paxos解除“Freezed”状态，重新开始正常工作。</li>
</ul>
</li>
</ol>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><em>我不想写总结了，这篇文章只是写给自己看的笔记而已为什么一定要写总结好烦啊啊啊啊啊</em></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/03/26/mit-distributed-system-course-summary/" data-id="cj3ebn2v100105z4kre1wkb5i" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/03/26/mit-distributed-system-course-summary/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed-system/">distributed-system</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/programming/">programming</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python-generators-coroutines-and-asyncio-library-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/" class="article-date">
  <time datetime="2016-03-21T03:29:22.000Z" itemprop="datePublished">2016-03-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/">Python coroutines and asyncio library (2)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h1><p>Suitable for <strong>I/O-bound</strong> tasks.</p>
<h3 id="futures"><a href="#futures" class="headerlink" title="futures"></a><code>futures</code></h3><p>“futures” — objects representing the asynchronous execution of an operation<br>an instance of either <code>asyncio.Future</code> or <code>concurrent.futures.Future</code> class represents a <strong>deferred</strong> computation that may or may not have completed. This is similar to the <code>Deferred</code> class in Twisted, the <code>Future</code> class in Tornado, and <code>Promise</code> objects in various JavaScript libraries.</p>
<ul>
<li><code>concurrent.futures</code> is based on thread/process rather than coroutines.</li>
<li>Client code is not supposed to change the state of a future: the concurrency framework changes the state of a future when the computation it represents is done, and we can’t control when that happens.</li>
<li>Users should not create them: they are meant to be instantiated exclusively by the concurrency framework, be it <code>concurrent.futures</code> or <code>asyncio</code>.</li>
<li><code>concurrent.futures.ThreadPoolExecutor</code> ::</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"><span class="keyword">from</span> flags <span class="keyword">import</span> save_flag, get_flag, show, main </div><div class="line"></div><div class="line">MAX_WORKERS = <span class="number">20</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc)</span>:</span></div><div class="line">    image = get_flag(cc)</div><div class="line">    show(cc)</div><div class="line">    save_flag(image, cc.lower() + <span class="string">'.gif'</span>) </div><div class="line">    <span class="keyword">return</span> cc</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span></div><div class="line">    workers = min(MAX_WORKERS, len(cc_list))</div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(workers) <span class="keyword">as</span> executor:</div><div class="line">        <span class="comment"># the `.map` method works like the built-in `map` method; it returns a generator that can be iterated over to </span></div><div class="line">        <span class="comment"># retrieve the value returned by each function (`download_one` here).</span></div><div class="line">        <span class="comment"># When iterating on the generator returned by `.map`, the `__next__` call invokes the `.result` method of each</span></div><div class="line">        <span class="comment"># future, and yield the result if the future is done. So here we cannot touch futures directly.</span></div><div class="line">        res = executor.map(download_one, sorted(cc_list)) </div><div class="line"></div><div class="line">    <span class="comment"># if any of the threaded calls raised an exception, that exception would be raised here as the implicit `next()`</span></div><div class="line">    <span class="comment"># call tried to retrieve the corresponding return value from the iterator.</span></div><div class="line">    <span class="keyword">return</span> len(list(res))</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main(download_many)</div></pre></td></tr></table></figure>
<p><code>concurrent.futures.as_completed</code><br>An idiom that’s very useful with <code>futures.as_completed</code>: building a dict to map each future to other data that may be useful when the future is <strong>completed</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> collections</div><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus </div><div class="line"><span class="keyword">from</span> flags2_sequential <span class="keyword">import</span> download_one</div><div class="line"></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">30</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(max_workers=concur_req) <span class="keyword">as</span> executor:</div><div class="line">        to_do_map = &#123;&#125;</div><div class="line">        <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list):</div><div class="line">            future = executor.submit(download_one,</div><div class="line">                            cc, base_url, verbose)</div><div class="line">            <span class="comment"># This dict will map each `Future` instance — representing one download — with the respective </span></div><div class="line">            <span class="comment"># country code for error reporting.</span></div><div class="line">            to_do_map[future] = cc</div><div class="line">        <span class="comment"># futures.as_completed returns an iterator that yields futures as they are done.</span></div><div class="line">        done_iter = futures.as_completed(to_do_map) </div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">            done_iter = tqdm.tqdm(done_iter, total=len(cc_list)) </div><div class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> done_iter:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                res = future.result()</div><div class="line">            <span class="keyword">except</span> requests.exceptions.HTTPError <span class="keyword">as</span> exc:</div><div class="line">                error_msg = <span class="string">'HTTP &#123;res.status_code&#125; - &#123;res.reason&#125;'</span> </div><div class="line">                error_msg = error_msg.format(res=exc.response)</div><div class="line">            <span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> exc: </div><div class="line">                error_msg = <span class="string">'Connection error'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                error_msg = <span class="string">''</span></div><div class="line">                status = res.status</div><div class="line"></div><div class="line">            <span class="keyword">if</span> error_msg:</div><div class="line">                status = HTTPStatus.error</div><div class="line">            counter[status] += <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                <span class="comment"># This was not necessary in the sequential version because we were iterating over the list </span></div><div class="line">                <span class="comment"># of country codes, so we had the current `cc`; here we are iterating over the futures.</span></div><div class="line">                cc = to_do_map[future]</div><div class="line">                print(<span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span>.format(cc, error_msg))</div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>
<h3 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a><code>asyncio</code></h3><p>Integrated into the standard library in Python <strong>3.4</strong>. Provides a way to drive asynchronous programs using <strong>event loop</strong>, which is different from Node.js.</p>
<p>Compared to multi-thread solutions, coroutines resides in a single thread, thus avoids most overhead due to thread context-switch. Plus, any time there can be only one coroutine running and it give out control actively, thus avoids most headaches due to synchronization since the coroutine knows that it won’t be interrupted unless voluntary suspends with <code>yield</code> (or <code>yield from</code>).</p>
<p>Note that, by design, there is no API for terminating a <strong>thread</strong> in Python. You must send it a message to shut down. Due to the GIL, race condition is alleviated at the expense of losing parallism. While for a coroutines, it can only be cancelled when it’s suspended at a <code>yield</code> point, so you can perform cleanup by handling the <code>CancelledError</code> exception (see below).</p>
<h4 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h4><p>“coroutine” in the context of <code>asyncio</code><br>A coroutine suitable for use with the <code>asyncio</code> API must use <code>yield from</code> and <strong>not</strong> <code>yield</code> in its body. Also, an <code>asyncio</code> coroutine should be driven by a caller invoking it through <code>yield from</code> or by passing the coroutine to one of the <code>asyncio</code> functions such as <code>asyncio.async(...)</code>. Finally, the <code>@asyncio.coroutine</code> decorator should be applied to coroutines.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="comment"># Coroutines intended for use with asyncio should be decorated with `@asyncio.coroutine`. </span></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spin</span><span class="params">(msg)</span>:</span></div><div class="line">write, flush = sys.stdout.write, sys.stdout.flush </div><div class="line"><span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">'|/-\\'</span>):</div><div class="line">    status = char + <span class="string">' '</span> + msg write(status)</div><div class="line">    flush()</div><div class="line">    write(<span class="string">'\x08'</span> * len(status)) </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># Use `yield from asyncio.sleep(.1)` instead of just `time.sleep(.1)`</span></div><div class="line">        <span class="comment"># to sleep without blocking the event loop.</span></div><div class="line">        <span class="comment"># Never use `time.sleep(...)` in `asyncio` coroutines unless you want to block the main thread,</span></div><div class="line">        <span class="comment"># therefore freezing the event loop and probably the whole application as well.</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">.1</span>) </div><div class="line">    <span class="comment"># The `CancelledError` exception can be catched in the `yield` where the coroutine is suspended.</span></div><div class="line">    <span class="keyword">except</span> asyncio.CancelledError:</div><div class="line">        <span class="keyword">break</span></div><div class="line">write(<span class="string">' '</span> * len(status) + <span class="string">'\x08'</span> * len(status))</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_function</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># pretend waiting a long time for I/O </span></div><div class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">3</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">42</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">supervisor</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># `asyncio.async(...)` schedules the `spin` coroutine to run, wrapping it in a `Task` </span></div><div class="line">    <span class="comment"># object, which is returned immediately. When you get a `Task` object, it is already scheduled to run</span></div><div class="line">    spinner = asyncio.<span class="keyword">async</span>(spin(<span class="string">'thinking!'</span>)) </div><div class="line">    print(<span class="string">'spinner object:'</span>, spinner)</div><div class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> slow_function() </div><div class="line">    <span class="comment"># This raises `CancelledError` inside the coroutine.</span></div><div class="line">    spinner.cancel()</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    <span class="comment"># Drive the supervisor coroutine to completion; </span></div><div class="line">    <span class="comment"># the return value of the coroutine is the return value of this call.</span></div><div class="line">    result = loop.run_until_complete(supervisor()) </div><div class="line">    loop.close()</div><div class="line">    print(<span class="string">'Answer:'</span>, result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main()</div></pre></td></tr></table></figure>
<p><code>asyncio.Futures</code> is designed to work with <code>yield from</code>  </p>
<ul>
<li>Using <code>yield from</code> with a future is the <strong>coroutine equivalent</strong> of the functionality offered by <code>add_donecallback</code>: instead of triggering a callback, when the delayed operation is done, the event loop sets the result of the future, and the <code>yield from</code> expression produces a return value inside our suspended coroutine, allowing it to resume.</li>
<li>You don’t need <code>my_future.add_donecallback(...)</code> because you can simply put whatever processing you would do after the future is done in the lines that follow <code>yield from my_future</code> in your coroutine. That’s the big advantage of having coroutines: functions that can be suspended and resumed.</li>
<li>You don’t need <code>my_future.result()</code> because the value of a <code>yield from</code> expression on a future is the result (e.g., <code>result = yield from my_future</code>).</li>
</ul>
<p>yielding from <code>Future</code>s, <code>Task</code>s, and coroutines<br>In <code>asyncio</code>, there is a close relationship between futures and coroutines because you can get the result of an <code>asyncio.Future</code> by yielding from it. This means that <code>res = yield from foo()</code> works if <code>foo</code> is a coroutine function (therefore it returns a coroutine object when called) or <strong>if <code>foo</code> is a plain function that returns a <code>Future</code> or <code>Task</code> instance</strong>.</p>
<p>executing coroutines<br>In order to execute, a coroutine must be scheduled, and then it’s wrapped in an <code>asyncio.Task</code>. Given a coroutine, there are two main ways of obtaining a Task:</p>
<p><code>asyncio.async(coro_orfuture, \*, loop=None)</code><br>This function unifies coroutines and futures: the first argument can be either one. If it’s a <code>Future</code> or <code>Task</code>, it’s returned unchanged. <strong>If it’s a coroutine, <code>async</code> calls <code>loop.create_task(...)</code> on it to create a <code>Task</code></strong>. An optional event loop may be passed as the <code>loop=</code> keyword argument; if omitted, <code>async</code> gets the loop object by calling <code>asyncio.get_eventloop()</code>.</p>
<p><code>BaseEventLoop.create_task(coro)</code><br>This method schedules the coroutine for execution and returns an <code>asyncio.Task</code> object. If called on a custom subclass of <code>BaseEventLoop</code>, the object returned may be an instance of some other Task-compatible class provided by an external library (e.g., Tornado).</p>
<ul>
<li>A coroutine only does anything when <strong>driven</strong>, and to drive an <code>asyncio.coroutine</code> you either use <code>yield from</code> or pass it to one of several <code>asyncio</code> functions that take coroutine or future arguments, such as <strong><code>run_untilcomplete</code></strong>. Several <code>asyncio</code> functions accept coroutines and wrap them in <code>asyncio.Task</code> objects automatically, <strong>using <code>asyncio.async</code> internally</strong>. One example is <strong><code>BaseEventLoop.run_untilcomplete(...)</code></strong>.</li>
</ul>
<h4 id="Downloading-with-asyncio-and-aiohttp"><a href="#Downloading-with-asyncio-and-aiohttp" class="headerlink" title="Downloading with asyncio and aiohttp"></a>Downloading with <code>asyncio</code> and <code>aiohttp</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> collections</div><div class="line"></div><div class="line"><span class="keyword">import</span> aiohttp</div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"></div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus, Result, save_flag</div><div class="line"></div><div class="line"><span class="comment"># default set low to avoid errors from remote site, such as</span></div><div class="line"><span class="comment"># 503 - Service Temporarily Unavailable</span></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">5</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FetchError</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, country_code)</span>:</span></div><div class="line">        self.country_code = country_code</div><div class="line"></div><div class="line"><span class="comment"># BEGIN FLAGS3_ASYNCIO</span></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_get</span><span class="params">(url)</span>:</span></div><div class="line">    res = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">'GET'</span>, url)</div><div class="line">    <span class="keyword">if</span> res.status == <span class="number">200</span>:</div><div class="line">        ctype = res.headers.get(<span class="string">'Content-type'</span>, <span class="string">''</span>).lower()</div><div class="line">        <span class="keyword">if</span> <span class="string">'json'</span> <span class="keyword">in</span> ctype <span class="keyword">or</span> url.endswith(<span class="string">'json'</span>):</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.json()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.read()</div><div class="line">        <span class="keyword">return</span> data</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> res.status == <span class="number">404</span>:</div><div class="line">        <span class="keyword">raise</span> web.HTTPNotFound()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">raise</span> aiohttp.errors.HttpProcessingError(</div><div class="line">            code=res.status, message=res.reason,</div><div class="line">            headers=res.headers)</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_country</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/metadata.json'</span>.format(base_url, cc=cc.lower())</div><div class="line">    metadata = <span class="keyword">yield</span> <span class="keyword">from</span> http_get(url)</div><div class="line">    <span class="keyword">return</span> metadata[<span class="string">'country'</span>]</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(base_url, cc=cc.lower())</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">yield</span> <span class="keyword">from</span> http_get(url))</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc, base_url, semaphore, verbose)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># A semaphore is used as a context manager in a `yield from` expression so that the system </span></div><div class="line">        <span class="comment"># as whole is not blocked: *only this coroutine* is blocked while the semaphore counter is at the </span></div><div class="line">        <span class="comment"># maximum allowed number.</span></div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(base_url, cc)</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            country = <span class="keyword">yield</span> <span class="keyword">from</span> get_country(base_url, cc)</div><div class="line">    <span class="keyword">except</span> web.HTTPNotFound:</div><div class="line">        status = HTTPStatus.not_found</div><div class="line">        msg = <span class="string">'not found'</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">        <span class="comment"># Any other exception will be reported as a `FetchError` with the country code and the original </span></div><div class="line">        <span class="comment"># exception chained using the `raise X from Y` syntax introduced in PEP 3134 — Exception </span></div><div class="line">        <span class="comment"># Chaining and Embedded Tracebacks.</span></div><div class="line">        <span class="keyword">raise</span> FetchError(cc) <span class="keyword">from</span> exc</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        country = country.replace(<span class="string">' '</span>, <span class="string">'_'</span>)</div><div class="line">        filename = <span class="string">'&#123;&#125;-&#123;&#125;.gif'</span>.format(country, cc)</div><div class="line">        loop = asyncio.get_event_loop()</div><div class="line">        <span class="comment"># Behind the scenes, the `asyncio` event loop has a thread pool executor, and you can send callables to be </span></div><div class="line">        <span class="comment"># executed by it with `run_in_executor`. This prevent the I/O function `save_fig` from blocking the whole thread.</span></div><div class="line">        loop.run_in_executor(<span class="keyword">None</span>, save_flag, image, filename)</div><div class="line">        status = HTTPStatus.ok</div><div class="line">        msg = <span class="string">'OK'</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> msg:</div><div class="line">        print(cc, msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Result(status, cc)</div><div class="line"><span class="comment"># END FLAGS3_ASYNCIO</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader_coro</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    <span class="comment"># Calling `.acquire()` does not block when the counter is greater than zero, but if the counter is zero, </span></div><div class="line">    <span class="comment"># `.acquire()` will block the calling *coroutine* until some other coroutine calls `.release()` on the same </span></div><div class="line">    <span class="comment"># `Semaphore`, thus incrementing the counter.</span></div><div class="line">    semaphore = asyncio.Semaphore(concur_req)</div><div class="line">    to_do = [download_one(cc, base_url, semaphore, verbose)</div><div class="line">             <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list)]</div><div class="line"></div><div class="line">    <span class="comment"># Note that the futures returned by `asyncio.as_completed` are not necessarily the same </span></div><div class="line">    <span class="comment"># futures passed into the `as_completed` call.</span></div><div class="line">    to_do_iter = asyncio.as_completed(to_do)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">        to_do_iter = tqdm.tqdm(to_do_iter, total=len(cc_list))</div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> to_do_iter:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            res = <span class="keyword">yield</span> <span class="keyword">from</span> future</div><div class="line">        <span class="keyword">except</span> FetchError <span class="keyword">as</span> exc:</div><div class="line">            country_code = exc.country_code</div><div class="line">            <span class="comment"># Try to retrieve the error message from the original exception (`__cause__`).</span></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                error_msg = exc.__cause__.args[<span class="number">0</span>]</div><div class="line">            <span class="comment"># If the error message cannot be found in the original exception, use the name </span></div><div class="line">            <span class="comment"># of the chained exception class as the error message.</span></div><div class="line">            <span class="keyword">except</span> IndexError:</div><div class="line">                error_msg = exc.__cause__.__class__.__name__</div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                msg = <span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span></div><div class="line">                print(msg.format(country_code, error_msg))</div><div class="line">            status = HTTPStatus.error</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            status = res.status</div><div class="line"></div><div class="line">        counter[status] += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    coro = downloader_coro(cc_list, base_url, verbose, concur_req)</div><div class="line">    counts = loop.run_until_complete(coro)</div><div class="line">    loop.close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> counts</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>
<h4 id="asyncio-Servers"><a href="#asyncio-Servers" class="headerlink" title="asyncio Servers"></a><code>asyncio</code> Servers</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">from</span> charfinder <span class="keyword">import</span> UnicodeNameIndex </div><div class="line"></div><div class="line">CRLF = <span class="string">b'\r\n'</span></div><div class="line">PROMPT = <span class="string">b'?&gt; '</span></div><div class="line">index = UnicodeNameIndex()</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_queries</span><span class="params">(reader, writer)</span>:</span> </div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="comment"># can't `yield from` since the `StreamWriter.write` method is not a coroutine, just a plain function</span></div><div class="line">        writer.write(PROMPT)</div><div class="line">        <span class="comment"># `StreamWriter.drain` flushes the writer buffer; it is a coroutine, so it must be called with `yield from`.</span></div><div class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">        data = <span class="keyword">yield</span> <span class="keyword">from</span> reader.readline()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            query = data.decode().strip() </div><div class="line">        <span class="keyword">except</span> UnicodeDecodeError:</div><div class="line">            query = <span class="string">'\x00'</span></div><div class="line">        client = writer.get_extra_info(<span class="string">'peername'</span>) </div><div class="line">        print(<span class="string">'Received from &#123;&#125;: &#123;!r&#125;'</span>.format(client, query)) </div><div class="line">        <span class="keyword">if</span> query:</div><div class="line">            <span class="keyword">if</span> ord(query[:<span class="number">1</span>]) &lt; <span class="number">32</span>: </div><div class="line">                <span class="keyword">break</span></div><div class="line">            lines = list(index.find_description_strs(query)) </div><div class="line">            <span class="keyword">if</span> lines:</div><div class="line">                writer.writelines(line.encode() + CRLF <span class="keyword">for</span> line <span class="keyword">in</span> lines) </div><div class="line">            writer.write(index.status(query, len(lines)).encode() + CRLF)</div><div class="line"></div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">            print(<span class="string">'Sent &#123;&#125; results'</span>.format(len(lines)))</div><div class="line"></div><div class="line">    print(<span class="string">'Close the client socket'</span>) </div><div class="line">    writer.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(address=<span class="string">'127.0.0.1'</span>, port=<span class="number">2323</span>)</span>:</span> </div><div class="line">    port = int(port)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    <span class="comment"># When completed, the coroutine object returned by `asyncio.start_server`</span></div><div class="line">    <span class="comment"># returns an instance of `asyncio.Server`, a TCP socket server.</span></div><div class="line">    server_coro = asyncio.start_server(handle_queries, address, port,</div><div class="line">                                loop=loop)</div><div class="line">    <span class="comment"># Drive server_coro to bring up the server.</span></div><div class="line">    server = loop.run_until_complete(server_coro)</div><div class="line">    host = server.sockets[<span class="number">0</span>].getsockname()</div><div class="line">    print(<span class="string">'Serving on &#123;&#125;. Hit CTRL-C to stop.'</span>.format(host)) </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># Run the event loop; this is where `main` will block until killed when CTRL-C is </span></div><div class="line">        <span class="comment"># pressed on the server console.</span></div><div class="line">        loop.run_forever()</div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt: <span class="comment"># CTRL+C pressed</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    print(<span class="string">'Server shutting down.'</span>) </div><div class="line">    server.close() </div><div class="line">    <span class="comment"># `server.wait_closed()` returns a future; use `loop.run_until_complete` to let the future do its job.</span></div><div class="line">    loop.run_until_complete(server.wait_closed()) </div><div class="line">    loop.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </div><div class="line">    main(*sys.argv[<span class="number">1</span>:])</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/" data-id="cj3ebn2ug000a5z4ksw6bwxs4" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python-generators-coroutines-and-asyncio-library-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/" class="article-date">
  <time datetime="2016-03-20T03:29:22.000Z" itemprop="datePublished">2016-03-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/">Python coroutines and asyncio library (1)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Coroutines"><a href="#Coroutines" class="headerlink" title="Coroutines"></a>Coroutines</h1><h3 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h3><p><strong>Coroutines are functions whose bodies contain <code>yield</code> or <code>yield from</code>.</strong></p>
<p>A coroutine can be in one of four states (‘GEN_CREATED’, ‘GEN_RUNNING’, ‘GEN_SUSPENDED’ and ‘GEN_CLOSED’). You can determine the current state using the <code>inspect.getgeneratorstate(...)</code> function.</p>
<p>The first activation of a coroutine is always done with <code>next(my_coro)</code> — you can also call <code>my_coro.send(None)</code>, and the effect is the same.</p>
<p>The initial call <code>next(my_coro)</code> is often described as “priming” the coroutine (i.e., advancing it to the first <code>yield</code> to make it ready for use as a live coroutine).</p>
<p>The execution of the coroutine is suspended <strong>exactly</strong> at the <code>yield</code> keyword. For example, in <code>a = yield b</code>, the value on the right of the <code>yield</code> keyword (value of <code>b</code>) is returned to the caller, and the coroutine give out control. After the caller invoking the <code>send</code> method to send a value, the coroutine takes over control back and the sent value is assigned to the name on the left side of the equation (the variable <code>a</code>).</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def simple_coro2(a):</div><div class="line">...     print('-&gt; Started: a =', a)</div><div class="line">...     b = yield a</div><div class="line">...     print('-&gt; Received: b =', b)</div><div class="line">...     c = yield a + b</div><div class="line">...     print('-&gt; Received: c =', c)</div><div class="line">...</div><div class="line">&gt;&gt;&gt; my_coro2 = simple_coro2(14)</div><div class="line">&gt;&gt;&gt; from inspect import getgeneratorstate </div><div class="line">&gt;&gt;&gt; getgeneratorstate(my_coro2) </div><div class="line">'GEN_CREATED'</div><div class="line">&gt;&gt;&gt; next(my_coro2)</div><div class="line">-&gt; Started: a = 14</div><div class="line">14</div><div class="line">&gt;&gt;&gt; getgeneratorstate(my_coro2) </div><div class="line">'GEN_SUSPENDED'</div><div class="line">&gt;&gt;&gt; my_coro2.send(28)</div><div class="line">-&gt; Received: b = 28</div><div class="line">42</div><div class="line">&gt;&gt;&gt; my_coro2.send(99)</div><div class="line">-&gt; Received: c = 99</div><div class="line">Traceback (most recent call last):</div><div class="line">  File "&lt;stdin&gt;", line 1, in &lt;module&gt; </div><div class="line">StopIteration</div><div class="line">&gt;&gt;&gt; getgeneratorstate(my_coro2) </div><div class="line">'GEN_CLOSED'</div></pre></td></tr></table></figure>
<h3 id="Exception-Handling"><a href="#Exception-Handling" class="headerlink" title="Exception Handling"></a>Exception Handling</h3><p>The caller can explicitly send exceptions into the coroutine via the <code>throw</code> and <code>close</code> method:</p>
<ul>
<li><p><code>generator.throw(exc_type[, exc_value[, traceback]])</code> causes the <code>yield</code> expression where the generator was paused to raise the exception given. If the exception is handled by the generator, flow advances to the next <code>yield</code>, and the value yielded becomes the value of the <code>generator.throw</code> call. If the exception is not handled by the generator, it propagates to the context of the caller.</p>
</li>
<li><p><code>generator.close()</code> causes the <code>yield</code> expression where the generator was paused to raise a <code>GeneratorExit</code> exception. No error is reported to the caller if the generator does not handle that exception or raises <code>StopIteration</code> — usually by running to completion. When receiving a <code>GeneratorExit</code>, the generator must not yield a value, otherwise a <code>RuntimeError</code> is raised. If any other exception is raised by the generator, it propagates to the caller.</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoException</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="string">"""An exception type for the demonstration."""</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo_finally</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'-&gt; coroutine started'</span>) </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>: </div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                x = <span class="keyword">yield</span></div><div class="line">            <span class="keyword">except</span> DemoException:</div><div class="line">                print(<span class="string">'*** DemoException handled. Continuing...'</span>) </div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                print(<span class="string">'-&gt; coroutine received: &#123;!r&#125;'</span>.format(x)) </div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        print(<span class="string">'-&gt; coroutine ending'</span>)</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"># 1. Activating and closing demo_exc_handling without an exception</div><div class="line">&gt;&gt;&gt; exc_coro = demo_exc_handling()</div><div class="line">&gt;&gt;&gt; next(exc_coro)</div><div class="line">-&gt; coroutine started</div><div class="line">&gt;&gt;&gt; exc_coro.send(11)</div><div class="line">-&gt; coroutine received: 11</div><div class="line">&gt;&gt;&gt; exc_coro.send(22)</div><div class="line">-&gt; coroutine received: 22</div><div class="line">&gt;&gt;&gt; exc_coro.close()</div><div class="line">&gt;&gt;&gt; from inspect import getgeneratorstate </div><div class="line">&gt;&gt;&gt; getgeneratorstate(exc_coro) 'GEN_CLOSED'</div><div class="line"></div><div class="line"># 2. Throwing DemoException into demo_exc_handling does not break it</div><div class="line">&gt;&gt;&gt; exc_coro = demo_exc_handling()</div><div class="line">&gt;&gt;&gt; next(exc_coro)</div><div class="line">-&gt; coroutine started</div><div class="line">&gt;&gt;&gt; exc_coro.send(11)</div><div class="line">-&gt; coroutine received: 11</div><div class="line">&gt;&gt;&gt; exc_coro.throw(DemoException)</div><div class="line">  *** DemoException handled. Continuing...</div><div class="line">&gt;&gt;&gt; getgeneratorstate(exc_coro)</div><div class="line">'GEN_SUSPENDED'</div><div class="line"></div><div class="line"># 3. Coroutine terminates if it can’t handle an exception thrown into it</div><div class="line">&gt;&gt;&gt; exc_coro = demo_exc_handling()</div><div class="line">&gt;&gt;&gt; next(exc_coro)</div><div class="line">-&gt; coroutine started</div><div class="line">&gt;&gt;&gt; exc_coro.send(11)</div><div class="line">-&gt; coroutine received: 11</div><div class="line">&gt;&gt;&gt; exc_coro.throw(ZeroDivisionError) </div><div class="line">Traceback (most recent call last):</div><div class="line">    ...</div><div class="line">ZeroDivisionError</div><div class="line">&gt;&gt;&gt; getgeneratorstate(exc_coro)</div><div class="line">'GEN_CLOSED'</div></pre></td></tr></table></figure>
<h3 id="The-yield-from-expression"><a href="#The-yield-from-expression" class="headerlink" title="The yield from expression"></a>The <code>yield from</code> expression</h3><h4 id="Basics-1"><a href="#Basics-1" class="headerlink" title="Basics"></a>Basics</h4><p><strong>After Python 3.3</strong>, a coroutine can <code>return</code> a value to the caller, but the value is an attribute of the <code>StopIteration</code> exception object (the <code>value</code> attribute). The <code>yield from</code> automatically primes the coroutine called by it, and handles the return value automatically by catching <code>StopIteration</code> internally.</p>
<p>The main feature of <code>yield from</code> is to <strong>open a bidirectional channel from the outermost caller to the innermost subgenerator</strong>, so that values can be sent and yielded back and forth directly from them, and exceptions can be thrown all the way in without adding a lot of exception handling boilerplate code in the intermediate coroutines. In the following, we will use following names to refer to different roles involved around a <code>yield from</code> expression:</p>
<ul>
<li>delegating generator : The generator function that contains the <code>yield from &lt;iterable&gt;</code> expression.</li>
<li>subgenerator : The generator obtained from the &lt;iterable&gt; part of the <code>yield from</code> expression. This is the “subgenerator” mentioned in the title of PEP 380: “Syntax for Delegating to a Subgenerator.”</li>
<li>caller : PEP 380 uses the term “caller” to refer to the client code that calls the delegating generator.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line">Result = namedtuple(<span class="string">'Result'</span>, <span class="string">'count average'</span>)</div><div class="line"></div><div class="line"><span class="comment"># the subgenerator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">averager</span><span class="params">()</span>:</span> </div><div class="line">    total = <span class="number">0.0</span></div><div class="line">    count = <span class="number">0</span> </div><div class="line">    average = <span class="keyword">None</span> </div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        term = <span class="keyword">yield</span></div><div class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="keyword">None</span>: <span class="comment"># The crucial terminating condition. Without it, a yield from calling this coroutine will block forever</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        total += term</div><div class="line">        count += <span class="number">1</span></div><div class="line">        average = total/count</div><div class="line">    <span class="keyword">return</span> Result(count, average) <span class="comment"># The returned Result will be the value of the yield from expression in grouper.</span></div><div class="line"></div><div class="line"><span class="comment"># the delegating generator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">grouper</span><span class="params">(results, key)</span>:</span> </div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="comment"># Whenever grouper is sent a value, it’s piped into the `averager` instance by the `yield from`. </span></div><div class="line">        <span class="comment"># `grouper` will be suspended here as long as the `averager` instance is consuming values sent by the </span></div><div class="line">        <span class="comment"># client. When an `averager` instance runs to the end, the value it returns is bound to `results[key]`.</span></div><div class="line">        <span class="comment"># The `while` loop then proceeds to create another `averager` instance to consume more values.</span></div><div class="line">        results[key] = <span class="keyword">yield</span> <span class="keyword">from</span> averager()</div><div class="line"></div><div class="line"><span class="comment"># the client code, a.k.a. the caller</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(data)</span>:</span> </div><div class="line">    results = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> key, values <span class="keyword">in</span> data.items(): </div><div class="line">        group = grouper(results, key) </div><div class="line">        next(group)</div><div class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> values:</div><div class="line">            <span class="comment"># Send each value into the grouper. That value ends up in the `term = yield` line of averager;</span></div><div class="line">            <span class="comment"># grouper never has a chance to see it.</span></div><div class="line">            group.send(value) </div><div class="line">        <span class="comment"># causes the current `averager` instance to terminate, and allows `grouper` to run again, which </span></div><div class="line">        <span class="comment"># creates another `averager` for the next group of values.</span></div><div class="line">        group.send(<span class="keyword">None</span>) <span class="comment"># important!</span></div><div class="line"></div><div class="line">    <span class="comment"># print(results)  # uncomment to debug</span></div><div class="line">    report(results)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">report</span><span class="params">(results)</span>:</span></div><div class="line">    <span class="keyword">for</span> key, result <span class="keyword">in</span> sorted(results.items()):</div><div class="line">        group, unit = key.split(<span class="string">';'</span>)</div><div class="line">        print(<span class="string">'&#123;:2&#125; &#123;:5&#125; averaging &#123;:.2f&#125;&#123;&#125;'</span>.format(</div><div class="line">              result.count, group, result.average, unit))</div><div class="line"></div><div class="line">data=&#123; <span class="string">'girls;kg'</span>:</div><div class="line">        [<span class="number">40.9</span>, <span class="number">38.5</span>, <span class="number">44.3</span>, <span class="number">42.2</span>, <span class="number">45.2</span>, <span class="number">41.7</span>, <span class="number">44.5</span>, <span class="number">38.0</span>, <span class="number">40.6</span>, <span class="number">44.5</span>],</div><div class="line">    <span class="string">'girls;m'</span>:</div><div class="line">        [<span class="number">1.6</span>, <span class="number">1.51</span>, <span class="number">1.4</span>, <span class="number">1.3</span>, <span class="number">1.41</span>, <span class="number">1.39</span>, <span class="number">1.33</span>, <span class="number">1.46</span>, <span class="number">1.45</span>, <span class="number">1.43</span>],</div><div class="line">    <span class="string">'boys;kg'</span>:</div><div class="line">        [<span class="number">39.0</span>, <span class="number">40.8</span>, <span class="number">43.2</span>, <span class="number">40.8</span>, <span class="number">43.1</span>, <span class="number">38.6</span>, <span class="number">41.4</span>, <span class="number">40.6</span>, <span class="number">36.3</span>],</div><div class="line">    <span class="string">'boys;m'</span>:</div><div class="line">        [<span class="number">1.38</span>, <span class="number">1.5</span>, <span class="number">1.32</span>, <span class="number">1.25</span>, <span class="number">1.37</span>, <span class="number">1.48</span>, <span class="number">1.25</span>, <span class="number">1.49</span>, <span class="number">1.46</span>],</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(data)</div></pre></td></tr></table></figure>
<ul>
<li><p>if a subgenerator never terminates, the delegating generator will be suspended forever at the <code>yield from</code>. This will not prevent your program from making progress because the <code>yield from</code> (like the simple <code>yield</code>) transfers control to the client code (i.e., the caller of the delegating generator). But it does mean that some task will be left unfinished.</p>
</li>
<li><p>Coroutines can be chained with <code>yield from</code>, but the end of the chain must be a simple iterator (or a coroutine uses only <code>yield</code> rather than <code>yield from</code>); And the whole chain is driven by a caller (must not be a coroutine!) by explicitly calling <code>next</code> or using a <code>for</code> loop implicitly.</p>
</li>
</ul>
<h4 id="Meaning-of-yield-from-from-the-delegating-generator’s-view"><a href="#Meaning-of-yield-from-from-the-delegating-generator’s-view" class="headerlink" title="Meaning of yield from (from the delegating generator’s view)"></a>Meaning of <code>yield from</code> (from the delegating generator’s view)</h4><p>Pseudocode equivalent to the statement <code>RESULT = yield from EXPR</code> in the delegating generator  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">_i = iter(EXPR) </div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="comment"># The subgenerator is primed</span></div><div class="line">    _y = next(_i)</div><div class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</div><div class="line">    _r = _e.value </div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="comment"># While this loop is running, the delegating generator is blocked, operating just as a channel </span></div><div class="line">    <span class="comment"># between the caller and the subgenerator</span></div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>: </div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            _s = <span class="keyword">yield</span> _y</div><div class="line">        <span class="comment"># This deals with closing the delegating generator and the subgenerator.</span></div><div class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> _e:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                _m = _i.close</div><div class="line">            <span class="keyword">except</span> AttributeError: </div><div class="line">                <span class="keyword">pass</span></div><div class="line">            <span class="keyword">else</span>: </div><div class="line">                _m()</div><div class="line">            <span class="keyword">raise</span> _e</div><div class="line">        <span class="comment"># This deals with exceptions thrown in by the caller using `.throw(...)`.</span></div><div class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> _e:</div><div class="line">            _x = sys.exc_info() </div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                _m = _i.throw </div><div class="line">            <span class="keyword">except</span> AttributeError:</div><div class="line">                <span class="keyword">raise</span> _e </div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    _y = _m(*_x)</div><div class="line">                <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e: </div><div class="line">                    _r = _e.value</div><div class="line">                    <span class="keyword">break</span> </div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="keyword">if</span> _s <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                    _y = next(_i) </div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    _y = _i.send(_s) </div><div class="line">            <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</div><div class="line">                _r = _e.value </div><div class="line">                <span class="keyword">break</span></div><div class="line"></div><div class="line"><span class="comment"># _r is the RESULT: the value of the whole `yield from` expression.</span></div><div class="line">RESULT = _r</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/" data-id="cj3ebn2u600065z4khj3dl9ur" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/03/20/Python-generators-coroutines-and-asyncio-library-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-A-Superhard-Elementary-Math-Problem" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/22/A-Superhard-Elementary-Math-Problem/" class="article-date">
  <time datetime="2016-02-22T02:29:22.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Math/">Math</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/22/A-Superhard-Elementary-Math-Problem/">A Superhard Elementary Math Problem</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><blockquote>
<p>设$a$和$b$是正整数，且$ab+1$整除$a^2+b^2$，求证：$\frac{a^2+b^2}{ab+1}$是完全平方数</p>
</blockquote>
<p>这个故事是我在Quora上看来的。正如文章的标题所述，这是个非常初等的问题：它可以用完全初等的语言描述，而且证明所需的数学工具也是非常初等的————事实上文章最后会给出完整的证明，非常简短，任何人都能轻易地理解。</p>
<p>然而，证明的思路却非常难想到：这个问题是1988年IMO（国际数学奥林匹克竞赛）的最后一题。比赛前这题目首先被提交给IMO的出题委员会审查，但没有一个人会做。于是后来这道题又被送给了澳大利亚（或者是奥地利？我记不太清原文中是Australia还是Austria了）的4名数论专家，也没有一个能在规定的6小时内解决这道题。因此这道题被归类到“superhard”那一档，并作为当年IMO的压轴题。</p>
<p>到了比赛时，有12名选手都在规定时间内把该题解决了，其中一个就是2010年的菲尔兹奖得主吴宝珠。而在那些<strong>没有</strong>做出这题的选手中，也有一个后来的菲尔兹奖得主————陶哲轩。（当然这并不能说明陶哲轩就不够厉害，要知道那时他才13岁）</p>
<hr>
<h1 id="Proof"><a href="#Proof" class="headerlink" title="Proof"></a>Proof</h1><p>我们用一个称为“无穷下降”的技巧来证明这个问题：所谓“无穷下降”，就是说假设整数$A$满足某个性质$P$，通过一些变换，我们可以得到一个整数$A’&lt;A$也满足$P$，依次类推就可以构造出一个无穷下降的整数列。当$A$的定义域是正整数集合时，由于不存在无穷下降的正整数列，就可以得到一个矛盾。</p>
<p>反证法：假设存在正整数$a$、$b$使$\frac{a^2+b^2}{ab+1}$<strong>不是</strong>完全平方数，在所有满足上述条件的$a$、$b$中选一对使$a+b$<strong>最小</strong>的，并设$k=\frac{a^2+b^2}{ab+1}$。<br>由于这里$a$、$b$的角色完全是对称的，因此不妨假设$a\geq b$，由$k=\frac{a^2+b^2}{ab+1}$知<br>$$<br>a^2−kba+(b^2−k)=0<br>$$<br>也即$a$是下述二次方程<br>$$<br>X^2-kbX+(b^2-k)=0<br>$$<br>的一个根。</p>
<p><strong>证明的关键思路在上述方程的另一个根身上</strong>：设另一个根为$a’$，则由二次方程根的性质有<br>$$<br>\begin{align}<br>&amp; a+a’=kb \\<br>&amp; aa’=b^2-k<br>\end{align}<br>$$</p>
<p>通过上面两个式子我们可以得到几个结论：</p>
<ul>
<li>由$a+a’=kb$知$a’$是整数</li>
<li>由$aa’=b^2-k$知$a’\neq 0$（由最开始时的假设，$k$不是完全平方数，因此$b^2-k\neq 0$）</li>
<li>$a’=\frac{b^2-k}{a}&lt;a$（由假设$a\geq b$）。</li>
</ul>
<p>注意到$a’$严格小于$a$，如果能证明$a’$是正整数的话，则因$a’+b&lt;a+b$，就与之前$a+b$最小的假设产生了矛盾，也就得出了我们想要的结论。事实上这是可以的：假设$a’&lt;0$，则</p>
<p>$$<br>0=a’^2-ka’b+(b^2-k)&gt;a’^2+k+b^2-k=0<br>$$</p>
<p>产生矛盾，因此必有$a’&gt;0$，证毕。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/02/22/A-Superhard-Elementary-Math-Problem/" data-id="cj3ebn2ua00085z4k119pnzde" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/02/22/A-Superhard-Elementary-Math-Problem/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/math/">math</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/puzzle/">puzzle</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-numpy-with-cython" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/20/numpy-with-cython/" class="article-date">
  <time datetime="2016-02-20T07:29:22.000Z" itemprop="datePublished">2016-02-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/20/numpy-with-cython/">Numpy with Cython</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文所用的例子来自一个编程作业。在该作业中要求实现一个集成学习算法，其中的主要部分就是训练多个感知机（Perceptron）。这里的感知机就是一个简单的线性分类器$f(\mathbf{x})=\text{sign}(\mathbf{w}^\top\mathbf{x}+b)$。假设训练样本为<br>$$<br>D={(\mathbf{x_1}, y_1),\ldots, (\mathbf{x}_N, y_N)}, \quad\mathbf{x}_i\in\mathbb{R}^D, y_i\in{0, 1}<br>$$<br>取$y’_i=2y_i-1$，则训练过程中参数的基本更新规则为<br>$$<br>\mathbf{w}^{(t+1)}=\mathbf{w}^{(t)}+\eta^{(t)} y’_i\mathbf{x}_i \quad\text{if}\quad y’_i(\mathbf{x}_i^\top\mathbf{w}^{(t)}+b^{(t)})&lt;0<br>$$<br>这其实就是基于hinge loss的SGD算法，其中$t$是迭代轮数，$\eta^{(t)}$是第$t$轮的步长，$\mathbf{x}_i$是随机sample的一个instance。在具体实现时可能会对上述规则做一些细微的修改，但基本规则不会有什么变化。</p>
<p>对于科学计算的任务（尤其是涉及到矩阵操作的任务），已经存在很好的Python数值计算库：<code>Numpy</code>与<code>Scipy</code>。其中<code>Numpy</code>实现了一个高效的（稠密）矩阵类型——<code>numpy.ndarray</code>，<code>Scipy</code>则提供了多种稀疏矩阵类型，且两个库之间还具有很好的互操作性。写过Matlab的同学肯定知道这样一条要诀：“任何能用矩阵操作的地方都不要用循环”。在用Python做科学计算时也有相同的原则，因为<code>Numpy</code>提供的矩阵操作其实都是对底层C程序的封装，可以完全离开Python解释器工作，因此速度相比于用<code>for</code>循环会快上很多倍（不过Python的解释器其实已经很快了，如果以后Pypy对<code>Numpy</code>的支持能够得到完善，那有些时候直接用<code>for</code>循环也是可以接受的）。但是总有这么些个算法，用矩阵操作来写就是不方便，而这里我们将要实现的SGD算法就是其中之一。</p>
<p>为什么Python这么慢？主要原因有两个：</p>
<ul>
<li><p>Python是一门解释型的（interpreted）语言，Python源代码在执行时会先编译成一种特殊的字节码（bytecode），然后交予Python虚拟机负责执行，这比直接编译成二进制的可执行文件（C/C++就是这样）来说就慢了不少。</p>
</li>
<li><p>Python是一门动态类型的（dynamically typed）语言，变量的具体类型只有在运行时才可知。事实上，Python解释器大部分时间都在干这么件事：弄清楚一个变量的当前类型到底是什么，然后把它底层的数据抽取出来进行运算。例如对<code>a+b</code>这条语句，解释器首先要查询某个表确定<code>a</code>和<code>b</code>的当前类型，然后确定该类型是否支持<code>+</code>操作，并把实际执行该操作的函数提取出来，接下来把<code>a</code>和<code>b</code>作为参数传给上述函数，而在该函数内部，则得先把<code>a</code>、<code>b</code>底层的数据取出来，完成实际的运算，再把结果包装成一个Python Object返回。整个过程会产生多次查询操作，且产生生成新的Python Object还需要在堆（heap）上分配空间。如果是C代码，由于已知<code>a</code>与<code>b</code>的类型，这个加法操作不过是一两条CPU指令的功夫。</p>
</li>
</ul>
<p>Python社区为这个问题提供了一个方便的解决方案：Cython。你可以简单地认为Cython是一种介于Python和C之间的编程语言，它为Python引入了C的静态类型系统（static type system），使得我们可以将Python代码和C代码无缝衔接。除此之外Cython还可以封装C/C++的动态链接库并提供针对Python的接口。最关键的是，用Cython操作<code>numpy.ndarray</code>非常方便，通过调用<code>numpy.ndarray.data</code>可以直接访问其在底层封装的C数组。</p>
<h2 id="Step-0：原始Python程序"><a href="#Step-0：原始Python程序" class="headerlink" title="Step 0：原始Python程序"></a>Step 0：原始Python程序</h2><p>下面是初版的程序，注意这是一个纯Python程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sgd.py</span></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> numpy.random <span class="keyword">as</span> random</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sgd</span><span class="params">(X, Y, ep)</span>:</span></div><div class="line">    <span class="string">""" Train a simple perceptron using SGD</span></div><div class="line">    </div><div class="line">    Parameters</div><div class="line">    ----------</div><div class="line">    X: array of shape=(n_samples, n_features) with dtype=np.float64</div><div class="line">        Each row contains the feature vector for a training sample instance.</div><div class="line">    Y: array of shape=(n_samples, ) with dtype=np.int64 ranging in &#123;0, 1&#125;</div><div class="line">        Corresponding label of training instances.</div><div class="line">    ep: double</div><div class="line">        Desired accuracy, which controls max iteration number.</div><div class="line">    </div><div class="line">    Returns</div><div class="line">    -------</div><div class="line">    w: array of shape=(n_features, ) with dtype=np.float64</div><div class="line">        Weights vector of the linear classifier</div><div class="line">    b: double</div><div class="line">        Intercept term of the linear classifier</div><div class="line">    """</div><div class="line">    n_samples, n_features = X.shape</div><div class="line">    </div><div class="line">    w = random.randn(n_features)</div><div class="line">    w_previous = w.copy() + <span class="number">1</span></div><div class="line">    b = <span class="number">0.0</span></div><div class="line">    </div><div class="line">    t = <span class="number">0</span></div><div class="line">    T = <span class="number">1</span> / ep ** <span class="number">2</span></div><div class="line">    idx = np.arange(n_samples)</div><div class="line"></div><div class="line">    <span class="keyword">while</span> t &lt; T:</div><div class="line">        <span class="comment"># check stop criterion</span></div><div class="line">        <span class="keyword">if</span> np.linalg.norm(w_previous - w) &lt;= <span class="number">0.0001</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            w_previous[:] = w</div><div class="line">            random.shuffle(idx)</div><div class="line"></div><div class="line">        <span class="comment"># update weights vector and intercept</span></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> idx:</div><div class="line">            lx = <span class="number">2</span> * Y[j] - <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> (w.dot(X[j].T) + b) * lx &lt; <span class="number">0</span>:</div><div class="line">                step_size = <span class="number">0.1</span> / (<span class="number">0.1</span> + t * ep ** <span class="number">2</span>)</div><div class="line">                w += step_size * X[j] * lx</div><div class="line">                b += step_size * lx</div><div class="line">            t += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> w, b</div></pre></td></tr></table></figure></p>
<p>这里有几个要点：</p>
<ul>
<li>主要的训练过程发生在第44-50行的内循环中，这也将是我们优化的重点。</li>
<li>第37-38行，每遍历数据集一次就检查权值向量$\mathbf{w}$的更新情况，若其变化不大就提前跳出循环。</li>
<li>第41行，用“先shuffle再顺序遍历”的方法来模拟SGD每次迭代中对$\mathbf{x}_i$的随机采样。</li>
</ul>
<h2 id="Step-1：明确标示所有变量的类型"><a href="#Step-1：明确标示所有变量的类型" class="headerlink" title="Step 1：明确标示所有变量的类型"></a>Step 1：明确标示所有变量的类型</h2><p>首先，为了区别Cython文件与Python文件，我们要把文件名改为<code>sgd.pyx</code>。其实这时候直接就可以用Cython编译它了，因为Cython的语法和Python的语法是兼容的：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>cython sgd.pyx</div></pre></td></tr></table></figure></p>
<p>但是这样做呢程序的性能并不会提升多少，我们还需要加点其它的东西进去，来帮助cython生成更高效的C代码。</p>
<p>第一件事就是显示声明<strong>每个</strong>变量的类型。正如文章开始时说过的，Python是动态类型的语言，每个变量的类型是在运行时决定的，若不声明变量类型，则Cython默认每个变量都是<code>PyObject</code>类型的，这个类型在Cython中用来指代Python对象。Cython操作这种类型的变量时和Python解释器的手法是一样的，因此会慢很多。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#sgd.pyx</span></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line">cimport numpy <span class="keyword">as</span> np</div><div class="line">cimport cython</div><div class="line"><span class="keyword">import</span> numpy.random <span class="keyword">as</span> random</div><div class="line"></div><div class="line">DTYPE = np.double</div><div class="line">ctypedef np.double_t DTYPE_t</div><div class="line">TTYPE = np.int64</div><div class="line">ctypedef np.int64_t TTYPE_t</div><div class="line"></div><div class="line"><span class="meta">@cython.cdivision(True)</span></div><div class="line"><span class="meta">@cython.boundscheck(False)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sgd</span><span class="params">(np.ndarray[DTYPE_t, ndim=<span class="number">2</span>] X,</span></span></div><div class="line">        np.ndarray[TTYPE_t, ndim=<span class="number">1</span>] Y,</div><div class="line">        double ep):</div><div class="line">    <span class="string">""" Train a simple perceptron using SGD</span></div><div class="line">    </div><div class="line">    Parameters</div><div class="line">    ----------</div><div class="line">    X: array of shape=(n_samples, n_features) with dtype=np.float64</div><div class="line">        Each row contains the feature vector for a training sample instance.</div><div class="line">    Y: array of shape=(n_samples, ) with dtype=np.int64 ranging in &#123;0, 1&#125;</div><div class="line">        Corresponding label of training instances.</div><div class="line">    ep: double</div><div class="line">        Desired accuracy, which controls max iteration number.</div><div class="line">    </div><div class="line">    Returns</div><div class="line">    -------</div><div class="line">    w: array of shape=(n_features, ) with dtype=np.float64</div><div class="line">        Weights vector of the linear classifier</div><div class="line">    b: double</div><div class="line">        Intercept term of the linear classifier</div><div class="line">    """</div><div class="line">    cdef int n_samples = X.shape[<span class="number">0</span>]</div><div class="line">    cdef int n_features = X.shape[<span class="number">1</span>]</div><div class="line"></div><div class="line">    cdef np.ndarray[DTYPE_t, ndim=<span class="number">1</span>] w = random.randn(n_features)</div><div class="line">    cdef np.ndarray[DTYPE_t, ndim=<span class="number">1</span>] w_previous = w.copy() + <span class="number">1</span></div><div class="line">    cdef double b = <span class="number">1.0</span></div><div class="line"></div><div class="line">    cdef unsigned T = &lt;unsigned&gt;(<span class="number">1</span> / ep ** <span class="number">2</span>)</div><div class="line">    cdef unsigned t = <span class="number">0</span></div><div class="line">    cdef long lx</div><div class="line">    cdef unsigned j</div><div class="line">    cdef double step_size</div><div class="line">    cdef np.ndarray[np.uint32_t, ndim=<span class="number">1</span>] idx = np.arange(n_samples, np.uint32)</div><div class="line"></div><div class="line">    <span class="keyword">while</span> t &lt; T:</div><div class="line">        <span class="comment"># check stop criterion</span></div><div class="line">        <span class="keyword">if</span> np.linalg.norm(w_previous - w) &lt;= <span class="number">0.0001</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            w_previous[:] = w</div><div class="line">            random.shuffle(idx)</div><div class="line"></div><div class="line">        <span class="comment"># update weights vector and intercept</span></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> idx:</div><div class="line">            lx = <span class="number">2</span> * Y[j] - <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> (w.dot(X[j].T) + b) * lx &lt; <span class="number">0</span>:</div><div class="line">                step_size = <span class="number">0.1</span> / (<span class="number">0.1</span> + t * ep ** <span class="number">2</span>)</div><div class="line">                w += step_size * X[j] * lx</div><div class="line">                b += step_size * lx</div><div class="line">            t += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> w, b</div></pre></td></tr></table></figure>
<ul>
<li>在Cython中，使用诸如<code>cdef int x</code>的语句来声明指定类型的变量，其中<code>cdef</code>是Cython关键字，<code>int</code>是类型（C类型或是通过<code>cdef</code>得到的<a href="http://docs.cython.org/src/tutorial/cdef_classes.html" target="_blank" rel="external">扩展类型</a>)，<code>x</code>是变量名。例子见下述代码中的第36、37行。</li>
<li>对于<code>numpy.ndarray</code>，Cython为之专门提供了用<code>cdef</code>重新封装过的版本（准确地说是用<code>cdef</code>定义了一个扩展类型）。为了使用该版本，需要用<code>cimport</code>把<code>numpy</code>重新导入一次（见第4行）。不过不用担心它和之前用<code>import</code>导入的<code>numpy</code>发生冲突，Cython会自动区分。<code>cimport</code>是Cython专用的语法，表示导入的是Cython模块（一般是一个<code>.pxd</code>文件）。</li>
<li>用<code>cdef</code>声明<code>numpy.ndarray</code>类型时，最好能够指出其中的数据类型以及矩阵的维度（例如函数参数中对<code>X</code>声明，见第15行）。<strong>多数时候</strong>这能大大提高编译后的代码中对矩阵的读写速度。不过注意这种优化方式仅当你使用“C-like indexing”（用D个typed variable索引维度为D的array，例如在本节代码中对<code>Y</code>的索引<code>Y[j]</code>）的时候才起作用，而若是使用<code>Numpy</code>的“fancy indexing”功能（例如在本节代码中对<code>X</code>每一行的索引<code>X[j]</code>）则起不到优化的效果。由于上述原因，这项优化在上述SGD代码中带来的性能提升并不明显。</li>
<li><code>numpy</code>提供了各种数据类型，包括<code>int32</code>、<code>float64</code>等，分别对应C语言中的32位有符号整数、64位浮点数。C语言中的基本数据类型都有<code>numpy</code>的对应版本。但这些类型不能直接与<code>cdef</code>结合使用，因为在<code>numpy</code>中这些类型都是Python对象。通过<code>cimport numpy</code>这条语句，我们可以得到上述类型的C版本的定义，只需要在原来的类型名字末尾加上<code>_t</code>即可，例子见第9、11行。</li>
<li><code>numpy.ndarray</code>支持负下标索引：类似Python中的<code>list</code>，-1表示最后一个元素，-2则是倒数第二个，依次类推。Cython默认开启对该功能的支持，而这也会减慢速度。关闭它的方法很简单：用<code>unsigned int</code>类型的变量进行矩阵索引，第46、48行声明的变量就是起这个作用。</li>
<li>Cython默认进行数组越界检查，这也是个降低速度的地方，不过可以用<code>@cython.boundscheck(False)</code>的方法关闭该功能（见第14行）</li>
</ul>
<h2 id="Step-2：添加对稀疏矩阵的支持"><a href="#Step-2：添加对稀疏矩阵的支持" class="headerlink" title="Step 2：添加对稀疏矩阵的支持"></a>Step 2：添加对稀疏矩阵的支持</h2><p>之前的程序默认输入的数据保存在<code>numpy.ndarray</code>对象中，这是一个稠密矩阵类型，在数据很稀疏时就不好用了。<code>scipy.sparse</code>提供了几种存储方式的稀疏矩阵，其底层其实都是用一个<code>ndarray</code>保存非零数据，再用几个<code>ndarray</code>保存数据的索引，唯一不同的只是构建索引的方式。最关键的是，这些底层的东西都可以通过某些办法直接操作的！</p>
<p>根据上面的思路，我模仿<code>sklearn.utils.seq_dataset</code>及<code>sklearn.utils.weight_vector</code>实现了两个容器<code>SequentialDataset</code>及<code>WeightVector</code>，但是针对自己的需要做了一些修改。其中<code>SequentialDataset</code>是用来操作训练数据集(<code>X</code>、<code>Y</code>)的，支持顺序存取及shuffle操作；<code>WeightVector</code>则是用来操作权值向量的，支持向量加法、内积、复制等操作。</p>
<p>由于篇幅所限，上述两个容器的代码实现不列出在这里，仅在后面做出简要说明，有兴趣同学可以去看<code>sklearn</code>中的<a href="https://github.com/scikit-learn/scikit-learn/tree/master/sklearn/utils" target="_blank" rel="external">源码[5]</a>，毕竟思路是来自那里。下面列出修改后的<code>sgd</code>代码：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"># cython: cdivision=True</div><div class="line"># cython: boundscheck=False</div><div class="line"># cython: wraparound=False</div><div class="line"></div><div class="line">from __future__ import division</div><div class="line">cimport cython</div><div class="line">import numpy <span class="keyword">as</span> np</div><div class="line">cimport numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line">from .container cimport SequentialDataset</div><div class="line">from .container cimport WeightVector</div><div class="line">from .container cimport DTYPE_t, YTYPE_t</div><div class="line"></div><div class="line">def sgd(SequentialDataset dataset,</div><div class="line">        np.ndarray[DTYPE_t, ndim=<span class="number">1</span>, <span class="keyword">mode</span>=<span class="string">'c'</span>] weights,</div><div class="line">        double intercept,</div><div class="line">        double ep,</div><div class="line">        bint shuffle, np.uint32_t seed):</div><div class="line">    <span class="string">""</span><span class="comment">"Train a perceptron-like linear classifier using Stochastic Gradient</span></div><div class="line">    Descent.</div><div class="line">    Parameters</div><div class="line">    ----------</div><div class="line">    datase<span class="variable">t:</span> SequentialDataset,</div><div class="line">        Training samples.</div><div class="line">    weight<span class="variable">s:</span> array of shape = [n_features] with dtype = np.DTYPE.</div><div class="line">        Allocated weight vector.</div><div class="line">    intercep<span class="variable">t:</span> DTYPE,</div><div class="line">        initial intercept value.</div><div class="line">    ep: double.</div><div class="line">        error tolerance, controls the iteration numbers. Training time will</div><div class="line">        <span class="keyword">be</span> roughly O(<span class="number">1</span>/min_node_err^<span class="number">2</span>).</div><div class="line">    Returns</div><div class="line">    -------</div><div class="line">    weights : array, shape=[n_features]</div><div class="line">        The fitted weight vector.</div><div class="line">    intercept : double</div><div class="line">        The fitted intercept term.</div><div class="line">    <span class="string">""</span><span class="comment">"</span></div><div class="line"></div><div class="line"></div><div class="line">    # acquire data information</div><div class="line">    cdef Py_ssize_t n_samples = dataset.n_samples</div><div class="line">    cdef Py_ssize_t n_features = weights.shape[<span class="number">0</span>]</div><div class="line">    cdef unsigned <span class="keyword">int</span> n_iter = <span class="built_in">max</span>(np.<span class="keyword">int</span>(<span class="number">1</span> / ep ** <span class="number">2</span>), <span class="number">1</span>)</div><div class="line"></div><div class="line">    # some helper variable<span class="variable">s:</span></div><div class="line">    # <span class="keyword">for</span> iteration</div><div class="line">    cdef unsigned <span class="keyword">int</span> n_outer = <span class="built_in">max</span>(n_iter, n_samples)</div><div class="line">    cdef unsigned <span class="keyword">int</span> n_inner = <span class="built_in">min</span>(n_iter, n_samples)</div><div class="line">    cdef unsigned <span class="keyword">int</span> t = <span class="number">0</span></div><div class="line">    cdef np.int64_t <span class="keyword">j</span> = <span class="number">0</span></div><div class="line"></div><div class="line">    # <span class="keyword">for</span> weight vector</div><div class="line">    cdef np.ndarray[DTYPE_t, ndim=<span class="number">1</span>] w_previous = weights.<span class="keyword">copy</span>() + <span class="number">1</span></div><div class="line">    cdef WeightVector <span class="keyword">w</span> = WeightVector(weights)</div><div class="line">    cdef WeightVector <span class="keyword">wp</span> = WeightVector(w_previous)</div><div class="line">    cdef DTYPE_t* w_data_ptr = NULL</div><div class="line">    cdef np.ndarray[<span class="keyword">int</span>, ndim=<span class="number">1</span>] w_indices = np.arange(n_features).astype(np.int32)</div><div class="line">    cdef <span class="keyword">int</span>* w_ind_ptr = &lt;<span class="keyword">int</span> *&gt;w_indices.data</div><div class="line">    cdef <span class="keyword">int</span> wnnz = <span class="symbol">&lt;int&gt;</span>n_features</div><div class="line"></div><div class="line">    # <span class="keyword">for</span> sample instance</div><div class="line">    cdef DTYPE_t *x_data_ptr = NULL</div><div class="line">    cdef <span class="keyword">int</span> *x_ind_ptr = NULL</div><div class="line">    cdef <span class="keyword">int</span> xnnz</div><div class="line">    cdef YTYPE_t <span class="keyword">y</span></div><div class="line"></div><div class="line">    # <span class="keyword">for</span> <span class="keyword">update</span></div><div class="line">    cdef double step_size = <span class="number">0</span></div><div class="line">    cdef YTYPE_t lx = <span class="number">0</span></div><div class="line">    cdef double <span class="keyword">p</span> = <span class="number">0.0</span></div><div class="line"></div><div class="line">    with nogi<span class="variable">l:</span></div><div class="line">        <span class="keyword">while</span> t &lt; n_outer:</div><div class="line">            <span class="keyword">if</span> shuffle:</div><div class="line">                dataset.shuffle(seed)</div><div class="line">            <span class="keyword">for</span> <span class="keyword">j</span> in <span class="built_in">range</span>(n_inner):</div><div class="line">                # <span class="built_in">get</span> <span class="keyword">next</span> sample</div><div class="line">                dataset.<span class="keyword">next</span>(&amp;x_data_ptr,</div><div class="line">                             &amp;x_ind_ptr,</div><div class="line">                             &amp;xnnz,</div><div class="line">                             &amp;<span class="keyword">y</span>)</div><div class="line">                lx = <span class="number">2</span> * <span class="keyword">y</span> - <span class="number">1</span></div><div class="line"></div><div class="line">                # <span class="keyword">update</span> weights with hinge loss</div><div class="line">                <span class="keyword">p</span> = (<span class="keyword">w</span>.dot(x_data_ptr, x_ind_ptr, xnnz) + intercept) * lx</div><div class="line">                <span class="keyword">if</span> <span class="keyword">p</span> &lt; <span class="number">0</span>:</div><div class="line">                    step_size = lx * <span class="number">0.1</span> / (<span class="number">0.1</span> + t * ep ** <span class="number">2</span>)</div><div class="line">                    <span class="keyword">w</span>.<span class="built_in">add</span>(x_data_ptr, x_ind_ptr, xnnz, step_size)</div><div class="line">                    intercept += step_size</div><div class="line">                t += <span class="number">1</span></div><div class="line"></div><div class="line">            # check <span class="keyword">for</span> early stopping</div><div class="line">            w_data_ptr = <span class="keyword">w</span>.w_data_ptr</div><div class="line">            <span class="keyword">wp</span>.<span class="built_in">add</span>(w_data_ptr, w_ind_ptr, wnnz, -<span class="number">1</span>)</div><div class="line">            <span class="keyword">if</span> t &lt; n_iter <span class="built_in">and</span> <span class="keyword">wp</span>.<span class="keyword">norm</span>() &lt;= <span class="number">0.0001</span>:</div><div class="line">                <span class="keyword">break</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">wp</span>.assign(<span class="keyword">w</span>)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> weights, intercept</div></pre></td></tr></table></figure>
<ul>
<li>注意在第73行，我使用<code>with nogil</code>显示地释放了GIL</li>
<li>其实在这里可以利用并行化来加速：在计算向量内积时使用<code>openmp</code>。（PS. 在Cython中使用<code>openmp</code>非常方便，具体见<a href="http://docs.cython.org/src/userguide/parallelism.html" target="_blank" rel="external">3</a>。</li>
<li>第14行，参数中的<code>dataset</code>变量代替了原本的<code>X</code>、<code>Y</code>矩阵，其提供了<code>shuffle</code>操作（见第76行）及<code>next</code>操作（第79行）。  <ul>
<li>其中<code>next</code>函数的作用是返回数据集中下一个样本。注意它返回向量<code>X[i]</code>的方式：使用三个量来描述一个向量，分别是<code>x_data_ptr</code>、<code>x_ind_ptr</code>及<code>xnnz</code>，可以近似地认为<code>x_data_ptr</code>是保存<code>X[i]</code>中非零元素的数组，<code>x_ind_ptr</code>则保存了各个非零元在<code>X[i]</code>中的列标，<code>xnnz</code>则是非零元的个数。这种表示方式源自<a href="https://en.wikipedia.org/wiki/Sparse_matrix#Yale" target="_blank" rel="external">CSR稀疏矩阵[4]</a>。</li>
</ul>
</li>
<li>第55行，用<code>WeightVector</code>变量代替了原本的<code>numpy.ndarray</code>。其提供四个操作：<code>add</code>、<code>dot</code>、<code>norm</code>及<code>assign</code>。前两个函数的参数列表类似<code>SequentialDataset.next</code>，是为了配合与样本向量的计算。</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] Cython Users Guide,<br><a href="http://docs.cython.org/src/userguide/index.html" target="_blank" rel="external">http://docs.cython.org/src/userguide/index.html</a></p>
<p>[2] Cython Tutorial: Working with Numpy,<br><a href="http://docs.cython.org/src/tutorial/numpy.html" target="_blank" rel="external">http://docs.cython.org/src/tutorial/numpy.html</a></p>
<p>[3] Cython Documentation: Using Parellelism,<br><a href="http://docs.cython.org/src/userguide/parallelism.html" target="_blank" rel="external">http://docs.cython.org/src/userguide/parallelism.html</a></p>
<p>[4] Compressed Row Storage,<br><a href="https://en.wikipedia.org/wiki/Sparse_matrix#Yale" target="_blank" rel="external">https://en.wikipedia.org/wiki/Sparse_matrix#Yale</a></p>
<p>[5] <code>seq_dataset.pyx</code> and <code>weight_vector.pyx</code>,<br><a href="https://github.com/scikit-learn/scikit-learn/tree/master/sklearn/utils" target="_blank" rel="external">https://github.com/scikit-learn/scikit-learn/tree/master/sklearn/utils</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/02/20/numpy-with-cython/" data-id="cj3ebn2uy000x5z4k7ygxjrtz" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/02/20/numpy-with-cython/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-debug-linux-0.11-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/20/debug-linux-0.11-2/" class="article-date">
  <time datetime="2016-02-20T06:29:22.000Z" itemprop="datePublished">2016-02-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/20/debug-linux-0.11-2/">调试在64位Debian上编译好的Linux 0.11（二）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本机环境:</p>
<ul>
<li>SMP Debian 3.11.6-1 (2013-10-27) x86_64 GNU/Linux</li>
<li>gcc (Debian 4.8.2-5) 4.8.2</li>
<li>GNU assembler (GNU Binutils for Debian) 2.23.90.20131116</li>
<li>GNU ld (GNU Binutils for Debian) 2.23.90.20131116</li>
<li>Bochs x86 Emulator 2.6</li>
</ul>
<p>编译时的一些设定：</p>
<pre><code>./Makefile

RAMDISK = -DRAMDISK=512  #设定虚拟盘大小为512KB
ROOT_DEV=FLOPPY
LD    =ld -m elf_i386 -Ttext 0 -e startup_32
</code></pre><h2 id="2-问题"><a href="#2-问题" class="headerlink" title="2.问题"></a>2.问题</h2><h3 id="2-在显示出“Loading-system”信息后就停止运行（续上篇文章）"><a href="#2-在显示出“Loading-system”信息后就停止运行（续上篇文章）" class="headerlink" title="2.在显示出“Loading system”信息后就停止运行（续上篇文章）"></a>2.在显示出“Loading system”信息后就停止运行（续<a href="http://blog.csdn.net/qqiseeu/article/details/16992565" target="_blank" rel="external">上篇文章</a>）</h3><p>类似的，<code>main()</code>中<code>drive_info=DRIVE_INFO</code>一行对应的汇编代码也使用了<code>rep</code>，而此时DF置位。在<code>main()</code>函数执行前使DF置位的命令只可能在boot/下的文件中出现。使用egrep寻找知：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">~/Src/</span>LinuxKernel<span class="regexp">/0.11/</span>linux<span class="number">-0.11</span>-deb$ egrep -nr <span class="string">'\&lt;std\&gt;'</span> boot/</div><div class="line">boot/head.<span class="string">s:</span><span class="number">209</span>:    std</div></pre></td></tr></table></figure></p>
<p>在213行加个<code>cld</code>就好。</p>
<h3 id="3-又出现类似问题2-1的情况"><a href="#3-又出现类似问题2-1的情况" class="headerlink" title="3.又出现类似问题2.1的情况"></a>3.又出现类似问题2.1的情况</h3><p>使用gdb单步调试，发现在转入进程1并执行<code>init()</code>-&gt;<code>setup()</code>-&gt;<code>bread()</code>调用时，触发page fault，且在<code>do_no_page()</code>-&gt;<code>get_free_page()</code>时跳转到一个全零的内存区域。检查汇编代码发现<code>get_free_page()</code>的地址并没有错误，但是其代码应该在的地方被清零了。</p>
<p>初步猜测是</p>
<ol>
<li>bootsect加载system模块时出错；</li>
<li>setup.s移动system模块时出错；</li>
<li><code>get_free_page()</code>所在的内存区域被违规擦写了。</li>
</ol>
<p>重新调试程序，刚进入<code>main()</code>函数时立即查看<code>get_free_page()</code>所在内存位置，发现其代码就在该处，因此可以排除前两条猜测。设断点于<code>bread()</code>函数，单步调试发现从<code>bread()</code>-&gt;<code>ll_rw_block()</code>-&gt;<code>make_request()</code>-&gt;<code>add_request()</code>-&gt;<code>do_hd_request()</code>-&gt;<code>reset_hd()</code>-&gt;<code>reset_hd()</code>-&gt;<code>hd_out()</code>的整个过程都未出现问题。这时时钟中断被触发（注意这是第一次触发时钟中断），继续step into发现在<code>time_interrupt()</code>-&gt;<code>do_timer()</code>的过程中，<code>do_timer()</code>调用了一个<code>next_timer</code>指向的函数，然而<code>next_timer</code>按理来说应该被初始化为NULL。查看其值发现<code>next_timer = 0x113</code>。</p>
<p>再次从头开始调试，发现在<code>setup.s</code>中把system模块从0x10000移到0x00000之后，<code>next_timer</code>就已经是非NULL值了。进一步检查发现<strong>sched.c</strong>中定义的所有<strong>全局static变量</strong>都被错误初始化了（我不知道为什么，如果有人知道的话请一定留言告诉我，谢谢！）。</p>
<p>修改方法：在<code>sched_init()</code>函数最后将上述全局static变量手动初始化：</p>
<pre><code>/* 
 * all the static variable with global scope defined in this
 * file are initialized incorrectly. I don&apos;t know why :-(
 */
memset(timer_list, 0, sizeof(timer_list));
if (next_timer != NULL)
    next_timer = NULL;

for (i=0; i&lt;4; i++) {
    wait_motor[i] = NULL;
    mon_timer[i] = moff_timer[i] = 0;
}
</code></pre><p>之后可以正确进入<code>mount_root()</code>函数并在屏幕上打印</p>
<blockquote>
<p>Insert root floppy and press ENTER</p>
</blockquote>
<p>的提示。</p>
<h3 id="4-插入系统盘并回车后，系统假死"><a href="#4-插入系统盘并回车后，系统假死" class="headerlink" title="4.插入系统盘并回车后，系统假死"></a>4.插入系统盘并回车后，系统假死</h3><p>从<code>mount_root()</code>函数开始调试，仔细检查从</p>
<p><code>mount_root()</code>-&gt;<code>read_super()</code>-&gt;<code>check_disk_change()</code>-&gt;<code>floppy_change()</code>-&gt;<code>floppy_on()</code>-&gt;<code>sleep_on()</code>-&gt;…</p>
<p>的整个流程，均未发现问题。然而在<code>mount_root()</code>调用<code>iget()</code>以获取第一个空闲inode时，发现<code>inode_table[]</code>也没有被正确地初始化为全零。意识到可能还有更多的全局变量/静态全局变量的初始化存在问题，我检查了内核中定义的所有全局变量/静态全局变量，发现还有<code>last_task_used_math</code>、<code>startup_time</code>、<code>jiffies</code>、<code>last_pid</code>也未正确初始化。手动将它们重置即可，或是干脆写个函数来一次性解决这个问题。（见<a href="https://github.com/ellipse/linux-0.11-deb/blob/master/kernel/var_init.c" target="_blank" rel="external">这里</a>）</p>
<h3 id="5-init-函数第一次调用open-时出错，无法打开“-dev-tty0”"><a href="#5-init-函数第一次调用open-时出错，无法打开“-dev-tty0”" class="headerlink" title="5.init()函数第一次调用open()时出错，无法打开“/dev/tty0”"></a>5.init()函数第一次调用open()时出错，无法打开“/dev/tty0”</h3><p>修复后可以成功装载根文件系统，接下来执行到open处再次出错。单步调试进入<code>open_namei()</code>-&gt;<code>dir_namei()</code>-&gt;<code>get_dir()</code>-&gt;<code>find_entry()</code>后发现，传给<code>find_entry()</code>的参数name在调用<code>match()</code>后值发生变化，然而<code>match()</code>函数不应该修改name的值:</p>
<pre><code>static int match(int len,const char * name,struct dir_entry * de)
{
    register int same;

    if (!de || !de-&gt;inode || len &gt; NAME_LEN)
        return 0;
    if (len &lt; NAME_LEN &amp;&amp; de-&gt;name[len])
        return 0;
    __asm__(&quot;cld\n\t&quot;
            &quot;fs ; repe ; cmpsb\n\t&quot;
            &quot;setz %%al&quot;
            :&quot;=a&quot; (same)
             :&quot;0&quot; (0),&quot;S&quot; ((long) name),&quot;D&quot; ((long) de-&gt;name),&quot;c&quot; (len));
    return same;
 }
</code></pre><p>为name增加一个watch point可注意到，在调用<code>match()</code>前，name被从edx寄存器移到esi寄存器中，而<code>match()</code>函数在未保存esi的情况下使用且改变了esi寄存器的值（通过rep指令），且在<code>match()</code>返回后，<code>find_entry()</code>依然通过esi中的地址来取name指向的字符串，这就造成每次调用<code>match()</code>后，name的值都不一样了。</p>
<p>通过反汇编<code>find_entry()</code>的目标代码发现，其调用<code>match()</code>时没有使用call指令，而是直接把<code>match()</code>的汇编代码嵌入到自己的汇编代码中去了，然后因其指定输入寄存器esi中的内容为name，所以之前有一个把name从edx移入esi的动作。gcc默认用来传递参数的寄存器是eax、edx、ecx，因此gcc会自动考虑是否需要“保存/恢复”这三个寄存器的指令。而<code>match()</code>使用内联汇编时操作的esi、edi作为手动指定的寄存器，需要自己增加保存/恢复的指令。</p>
<p>修改方法：在<code>match()</code>的内联汇编的前后使用push/pop保存并恢复esi寄存器的值。</p>
<p>注意到内核代码中存在大量内联汇编，它们都可能出现类似问题，因此应<strong>给所有使用esi/edi作为输入寄存器的内联汇编代码前后加上一对pushl/popl</strong>。</p>
<h2 id="3-结语"><a href="#3-结语" class="headerlink" title="3.结语"></a>3.结语</h2><p>做完上述修改后内核就可以在bochs中运行了。我把所有对内核代码的修改生成了一个<a href="https://github.com/ellipse/linux-0.11-deb" target="_blank" rel="external">patch文件</a>，放在github上。由于水平所限，有一些问题的原理我也不清楚，解决的时候带有一点猜的性质，如果大家发现文中存在什么错误，还请一定指出。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/02/20/debug-linux-0.11-2/" data-id="cj3ebn2up000m5z4kbmul2xef" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/02/20/debug-linux-0.11-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-debug-linux-0.11-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/20/debug-linux-0.11-1/" class="article-date">
  <time datetime="2016-02-20T05:29:22.000Z" itemprop="datePublished">2016-02-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/20/debug-linux-0.11-1/">调试在64位Debian上编译好的Linux 0.11（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本机环境:</p>
<ul>
<li>SMP Debian 3.11.6-1 (2013-10-27) x86_64 GNU/Linux</li>
<li>gcc (Debian 4.8.2-5) 4.8.2</li>
<li>GNU assembler (GNU Binutils for Debian) 2.23.90.20131116</li>
<li>GNU ld (GNU Binutils for Debian) 2.23.90.20131116</li>
<li>Bochs x86 Emulator 2.6</li>
</ul>
<p>编译时的一些设定：</p>
<pre><code>./Makefile

RAMDISK = -DRAMDISK=512  #设定虚拟盘大小为512KB
ROOT_DEV=FLOPPY
LD    =ld -m elf_i386 -Ttext 0 -e startup_32
</code></pre><h2 id="1-调试前的准备"><a href="#1-调试前的准备" class="headerlink" title="1.调试前的准备"></a>1.调试前的准备</h2><h3 id="1-制作内核引导Image"><a href="#1-制作内核引导Image" class="headerlink" title="1.制作内核引导Image"></a>1.制作内核引导Image</h3><p>为了把编译好的内核镜像放到bochs中运行，首先制作内核引导Image，具体为（参考<a href="http://book.douban.com/subject/1481173/" target="_blank" rel="external">Linux内核完全剖析</a>）：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#也可以用下述命令替换顶层Makefile中的disk目标下的命令</div><div class="line"><span class="selector-tag">dd</span> <span class="keyword">if</span>=Image of=bootimage-fda<span class="selector-class">.img</span></div><div class="line"><span class="selector-tag">dd</span> bs=<span class="number">1024</span> <span class="keyword">if</span>=/dev/zero of=bootimage-fda<span class="selector-class">.img</span> seek=<span class="number">256</span> count=<span class="number">1184</span></div></pre></td></tr></table></figure>
<p>其中<code>Image</code>是之前编译出的内核镜像。上述操作得到一个大小为1.44MB的Image文件<code>bootimage-fda.img</code>，将作为在bochs中使用的引导盘。注意此时我们仍未创建根文件系统，而在Makefile中设置了<code>ROOT_DEV=FLOPPY</code>，因此正常情况下在fork出进程1、进程1调用<code>setup((void*)&amp;drive_info)</code>安装根文件系统时，会提示插入含有根文件系统的软盘，不过这暂时不用担心。</p>
<h3 id="2-设置bochs"><a href="#2-设置bochs" class="headerlink" title="2.设置bochs"></a>2.设置bochs</h3><p>接下来设置bochs，仍参考<a href="http://book.douban.com/subject/1481173/" target="_blank" rel="external">Linux内核完全剖析</a>，但由于书中使用的bochs版本较老，有些选项的写法需要修改：</p>
<pre><code>./bochsrc-fda.bxrc

romimage: file=$BXSHARE/BIOS-bochs-latest
megs: 16
vgaromimage: file=$BXSHARE/VGABIOS-elpin-2.40
floppya: 1_44=&quot;bootimage-fda.img&quot;, status=inserted
floppyb: 1_44=diskb.img, status=inserted
ata0-master: type=disk, path=&quot;hdc-0.11-new.img&quot;, mode=flat, cylinders=121, heads=16, spt=63
boot: a
log: bochs.out
parport1: enabled=0
vga: update_freq=5
keyboard: paste_delay=100000, serial_delay=200
cpu: count=1, ips=4000000
mouse: enabled=0
</code></pre><p>注意其中用到的<code>diskb.img</code>与<code>hdc-0.11-new.img</code>是<a href="http://www.oldlinux.org/Linux.old/bochs/linux-0.11-devel-060625.zip" target="_blank" rel="external">这个包</a>提供的。其中也包含了做好的根文件系统镜像，可以直接用。然后就可以直接运行系统了！</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bochs </span>-f <span class="keyword">bochsrc-fda.bxrc</span></div></pre></td></tr></table></figure>
<h3 id="3-设置添加了gdb-stub功能的bochs"><a href="#3-设置添加了gdb-stub功能的bochs" class="headerlink" title="3.设置添加了gdb-stub功能的bochs"></a>3.设置添加了gdb-stub功能的bochs</h3><p>调试C程序代码时很多时候还是用gdb更为方便，因此可以专门编译出一份开启了<code>gdb-stub</code>功能的bochs，并将其重命名为bochs-gdb以与原来的bochs区分。若要换用开启了“gdb-stub”功能的bochs进行调试，则给所有Makefile文件中的CFLAGS加上 <strong>-g</strong> 选项，去除所有LDFLAGS中的 <strong>-s</strong> 选项。此时system模块由于附加了大量调试信息，大小超过了顶层Makefile中设定的限制<code>SYSSIZE = 0x3000</code>,因此可将顶层Makefile中的<code>tools/system</code>目标修改如下：</p>
<pre><code>tools/system:    boot/head.o init/main.o \
                $(ARCHIVES) $(DRIVERS) $(MATH) $(LIBS)
        $(LD) $(LDFLAGS) boot/head.o init/main.o \
        $(ARCHIVES) \
        $(DRIVERS) \
        $(MATH) \
        $(LIBS) \
        -o tools/system &gt; System.map
        objcopy --only-keep-debug tools/system tools/system.dbg
        objcopy --add-gnu-debuglink=tools/system.dbg tools/system
        objcopy -g tools/system
</code></pre><p>将调试信息抽取出来专门存于一个文件system.dbg中，gdb执行时将会利用该调试信息文件。</p>
<h2 id="2-问题"><a href="#2-问题" class="headerlink" title="2.问题"></a>2.问题</h2><h3 id="1-无法正确载入system模块"><a href="#1-无法正确载入system模块" class="headerlink" title="1.无法正确载入system模块"></a>1.无法正确载入system模块</h3><p>直接运行内核发现bochs的虚拟终端上不断刷新如下信息</p>
<pre><code>...
ata0 master: Generic 1234 ATA-6 Hard-Disk ( 121 MBytes)
Press F12 for boot menu.
Booting from Floppy...
Loading system ...
</code></pre><p>初步猜测进入了某个死循环。使用打开了调试功能的bochs单步调试发现，程序执行到<code>setup.s</code>中第193行之前都正常</p>
<pre><code>boot/setup.s

193   jmpi  0, 8  ! jmp offset 0 of segment 8(cs)
</code></pre><p>这一行的功能是跳转到cs段偏移0处（<strong>此时保护模式已打开</strong>），实际上就是物理地址0x0处。该地址此时应为system模块的起始处（因在进入保护模式前，<code>setup.s</code>中113-126行的代码已将system模块从线性地址<strong>0x10000</strong>移至<strong>0x0000</strong>，而当时线性地址0x0与物理地址0x0是重合的）。然而此时查看物理地址0x0处的内容发现，从该处开始有很长一段（事实上足足有3KB）的值是全零，因此system模块必然出了问题。问题只能出在三个地方：</p>
<ul>
<li><code>bootsect.s</code>中109行，将system模块从磁盘上读入内存0x10000处时</li>
<li><code>setup.s</code>中113-126行，将system模块从0x10000复制到0x00000处时</li>
<li><code>build.c</code>中157-167行，将system模块组装到Image中时（话说这个我一开始还真没想到）</li>
</ul>
<p>通过bochs调试前两处可能出现错误的地方，没有发现任何问题，因此问题只可能出在system模块本身。根据<code>bootsect.s</code>中读入system模块的代码，发现其是从第5个磁盘块（每个磁盘块大小为1KB）开始读入system模块的，因此system模块的起始地址应为Image中第2.5KB处，即地址<strong>0x0a00</strong>，然而使用hexdump查看Image文件发现，system模块实际上是从<strong>0x1600</strong>字节处开始的，等于说存在一个3KB大小的空洞！build.c中组装system模块的代码如下：</p>
<pre><code>tools/build.c

157    if ((id=open(argv[3],O_RDONLY,0))&lt;0)
158        die(&quot;Unable to open &apos;system&apos;&quot;);
159    if (read(id,buf,GCC_HEADER) != GCC_HEADER)
160        die(&quot;Unable to read header of &apos;system&apos;&quot;);
161    if (((long *) buf)[6] != 0)
162           die(&quot;Non-GCC header of &apos;system&apos;&quot;);
163    for (i=0 ; (c=read(id,buf,sizeof buf))&gt;0 ; i+=c )
164       if (write(1,buf,c)!=c)
165           die(&quot;Write call failed&quot;);
166    close(id);
</code></pre><p>可以看出，build程序先读取system模块的GCC_HEADER（实际上就是ELF头）判断文件格式的合法性，然后抛弃该文件头，把剩下的内容添加到Image文件中。这里有一个隐含的假设：system模块的ELF头大小就是1KB！然而实际上，这个用现代版本gcc编译出来的目标文件，其ELF头的大小是4KB（这也可以通过hexdump看出）。因此build程序实际上应该丢弃system模块前4KB的内容。在163行前加上下述代码即可：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/* The header size <span class="keyword">is</span> <span class="number">4</span>*GCC_HEADER (<span class="number">4</span>KB) <span class="keyword">on</span> <span class="keyword">my</span> machine*/</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">read</span>(<span class="built_in">id</span>,buf,GCC_HEADER) != GCC_HEADER)</div><div class="line">			die(<span class="string">"Unable to read header of 'system'"</span>);</div></pre></td></tr></table></figure></p>
<h3 id="2-在显示出“Loading-system”信息后就停止运行"><a href="#2-在显示出“Loading-system”信息后就停止运行" class="headerlink" title="2.在显示出“Loading system”信息后就停止运行"></a>2.在显示出“Loading system”信息后就停止运行</h3><p>按正常情况，应该是在<code>mount_root()</code>函数显示出</p>
<blockquote>
<p>Insert root floppy and press ENTER</p>
</blockquote>
<p>信息之后系统再暂停运行，然而这里的情况表明程序根本没有执行到这一步。在main.c中的<code>init()</code>调用<code>setup()</code>之前插一句<code>printk(&quot;entering init&quot;);</code>再重新运行一遍程序，发现根本没有执行到这一行，则有如下几种可能：</p>
<ul>
<li><code>fork()</code>调用存在问题</li>
<li>进程调度存在问题</li>
</ul>
<p>首先用bochs调试代码，检查main.c中定义的内联版本的<code>fork()</code>是否被正确展开（其实就是检查<code>main()</code>调用<code>fork()</code>时有没有用call指令。因为<a href="http://blog.chinaunix.net/uid-23917107-id-3173253.html" target="_blank" rel="external">这里</a>提到过GCC有时不会把该函数按内联的方式展开）。在我的电脑上编译出来的代码中，这一步是没有问题的，于是接下来深入<code>sys_fork</code>调用去检查。换用bochs-gdb调试代码，结果发现<code>copy_process()</code>中子进程复制父进程task_struct时出现了问题：</p>
<pre><code>*p = *current;
</code></pre><p>这一步执行完后，并没有把<code>*current</code>复制给<code>*p</code>。查看这两个task_struct结构的周边内存，发现下述情况</p>
<pre><code>...
(gdb) x /16 0x00017140
0x17140 &lt;current&gt;: 0x00017160 0x00000000 0x00000000 0x00000000
0x17150: 0x00000000 0x00000000 0x00000000 0x00000000
0x17160: 0x00000000 0x00000000 0x00000000 0x00000000
0x17170: 0x00000000 0x00000000 0x00000000 0x00000000
(gdb) x /16 0x00ffefe0
0xffefe0: 0x00017160 0x00000000 0x00000000 0x00000000
0xffeff0: 0x00000000 0x00000000 0x00000000 0x00000000
0xfff000: 0x00000000 0x00000000 0x00000000 0x00000000
0xfff010: 0x00000000 0x00000000 0x00000000 0x00000000
...
</code></pre><p>本次调试时<code>p=0x00fff000</code>，<code>current=0x00017160</code>，注意到位于地址<strong>0x17140</strong>的值似乎被复制到了地址<strong>0xffefe0</strong>处，这可能说明复制时是往<strong>低地址方向</strong>复制的。于是在gdb中使用<code>set disassemble-next-line on</code>命令查看<code>copy_process()</code>中<code>*p = *current</code>语句产生的汇编代码得：</p>
<pre><code>...
*p = *current; /* NOTE! this doesn&apos;t copy the supervisor stack */
=&gt; 0x00007a8a &lt;copy_process+35&gt;:  mov  0x17140,%esi
   0x00007a90 &lt;copy_process+41&gt;:  mov  $0xef,%ecx
   0x00007a95 &lt;copy_process+46&gt;:  mov  %ebx,%edi
   0x00007a97 &lt;copy_process+48&gt;:  rep movsl %ds:(%esi),%es:(%edi)
</code></pre><p>可见此时使用了<code>rep movsl</code>的方法来复制内存。根据<a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html" target="_blank" rel="external">Intel的手册</a>对该指令的描述，其复制方向受EFLAGS寄存器中DF位控制：DF=0时往高地址方向复制（这也是默认情况），DF=1时往低地址方向复制。用<code>info registers</code>查看EFLAGS寄存器的值，果然DF位被置位了。此时编译器认为DF位为0，然而实际上DF=1 。我对于编译原理了解不多，故只能猜测将DF位置位的代码并不是由编译器编译C代码产生的（否则编译器应该会知道自己将DF置位了），因此应是之前某手工编写的汇编代码中存在<code>std</code>指令，且之后没有用<code>cld</code>复位。搜索源文件知</p>
<pre><code>~/Src/LinuxKernel/0.11/linux-0.11-deb$ egrep -nr &apos;\Wstd\W&apos; .
./mm/memory.c:67:     __asm__(&quot;std ; repne ; scasb\n\t&quot;
./kernel/chr_drv/console.c:189:     __asm__(&quot;std\n\t&quot;
./kernel/chr_drv/console.c:174:     __asm__(&quot;std\n\t&quot;
./include/string.h:352:    __asm__(&quot;std\n\t&quot;
</code></pre><p>在这四个使用了<code>std</code>指令的内联汇编代码的最后都加上一句<code>cld</code>复位DF位即可。</p>
<p>“Intel® 64 and IA-32 Architectures Software Developer’s Manual, Volume 2 (2A, 2B &amp; 2C): Instruction Set Reference, A-Z”</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xyguo.github.io/2016/02/20/debug-linux-0.11-1/" data-id="cj3ebn2un000k5z4kfs8m6xr2" class="article-share-link">Share</a>
      
        <a href="http://xyguo.github.io/2016/02/20/debug-linux-0.11-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/english-writing/">english-writing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">programming</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Emacs/">Emacs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-system/">distributed-system</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/puzzle/">puzzle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/style-lessons-in-clarity-and-grace/">style-lessons-in-clarity-and-grace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writing/">writing</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/Linux-Kernel/" style="font-size: 20px;">Linux Kernel</a> <a href="/tags/distributed-system/" style="font-size: 10px;">distributed-system</a> <a href="/tags/math/" style="font-size: 15px;">math</a> <a href="/tags/programming/" style="font-size: 10px;">programming</a> <a href="/tags/puzzle/" style="font-size: 10px;">puzzle</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/style-lessons-in-clarity-and-grace/" style="font-size: 15px;">style-lessons-in-clarity-and-grace</a> <a href="/tags/writing/" style="font-size: 15px;">writing</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/05/notes-on-style-book-ch4/">English writing - Characters</a>
          </li>
        
          <li>
            <a href="/2017/02/19/notes-on-style-book-ch3/">English writing - Actions</a>
          </li>
        
          <li>
            <a href="/2016/09/22/chernoff-hoeffding/">Chernoff-Hoeffding Bound</a>
          </li>
        
          <li>
            <a href="/2016/03/26/mit-distributed-system-course-summary/">Summary for MIT 6.824- Course projects</a>
          </li>
        
          <li>
            <a href="/2016/03/21/Python-generators-coroutines-and-asyncio-library-2/">Python coroutines and asyncio library (2)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 xyguo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/links" class="mobile-nav-link">Links</a>
  
</nav>
    
<script>
  var disqus_shortname = 'xyguo';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>